<!DOCTYPE html>
<html>
<head>
  <title>SMART HOME INTERFACE</title>  
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="initial-scale=1.0">
  <meta name="viewport" content="maximum-scale=1.0">
  <meta name="viewport" content="user-scalable=no">
  <meta name="viewport" content="width=device-width">
  <link rel="apple-touch-icon-precomposed" href="http://elfege.com/penrose.jpg">
  <link rel="apple-touch-startup-image" href="http://elfege.com/penrose.jpg">

  <style>
    :root {
      --buttonSize:80px;
      --tdSize: calc(var(--buttonSize)* 2);
      --buttonGroupMargin: 2px;
      --sliderSpanTDmarginLEFT: 5px; 
      --sliderSpanTDmarginRIGHT: 7px; 
      --sliderLength: 200px; /*calc(var(--buttonSize) * 2); /*buttonSize x 2 */
      --sliderLengthHover: calc(var(--sliderLength) + 20px);;
      --sliderWidth: 10px;
      --buttonFontSize:12px;
      --fontSize:20px;
      --fontColor:#0B0B0A;
      --buttonColor:#64AEB1;
      --defautlRadiusVal: 3px;
      --hoverRadiusVal: 30px;
      --buttonTransition:  0.5s;
      --headerButtonHeight: 25px;
      --headerButtonWidth: var(--buttonSize);

      --backgroundColor: linear-gradient(0deg, rgba(131,58,180,1) 0%, rgba(86,57,78,1) 29%, rgba(253,48,29,1) 100%, rgba(252,176,69,1) 100%);
      --backgroundColor2: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 33%, rgba(0,212,255,1) 100%);
      --backgroundColor3: linear-gradient(0deg, rgba(131,58,180,1) 0%, rgba(86,57,78,1) 29%, rgba(253,48,29,1) 100%); 
      --backgroundColor4: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(63,184,154,1) 0%, rgba(0,212,255,1) 100%);
      --backgroundColor5: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(84,75,141,1) 0%, rgba(0,212,255,1) 100%);
      --backgroundColorSliderRamp: red;

      --buttonOffHover: yellow; /*"linear-gradient(45deg, #F1F116, #D5D536, #B6B644, #92921C, #E0310E)";*/
      --buttonOnHover: darkgrey; /*"linear-gradient(45deg, #5E6060, #517979, #3E9D9D, #31BCBC, #18A2E0)";*/ 
      --buttonOff: darkgrey;     /*"linear-gradient(45deg, #5E6060, #517979, #3E9D9D, #31BCBC, #18A2E0)";*/ 
      --buttonOn:  white;     /*"linear-gradient(45deg, #F1F116, #D5D536, #B6B644, #92921C, #E0310E)";*/
    }
    body {
      zoom: 1 ;
      /*background-image: url("/img1.jpg");*/
      background-repeat: no-repeat;
      background-size: 100%;
      background-color: blue;
      height: 100vh;
      margin: 0;
      background-attachment: fixed;
      opacity: 1;
      cursor: move;
    }
    table {
      width:100%;
      border: 0px solid white;
      padding: 0px;
      text-align: center;
      opacity: 1;
    }
    tr {
      border: 0px solid white;
    }
    td {
      border: 0px solid white;

    }
    .verticalSlider {
      -webkit-appearance: none;
      /*transform: rotate(270deg);*/
      overflow: hidden;
      width: width:relative; /*var(--sliderLength);*/
      height: var(--sliderWidth);
      background-color: white;
      cursor: pointer;
    }

    .verticalSlider::after {
    }
    .verticalSlider.on {
    }
    .verticalSlider.off {
    }

    .verticalSlider::-webkit-slider-thumb {   
      -webkit-appearance: none;
      width: 25px;
      height:50px;
      cursor: ew-resize;
      background-color: darkblue;
      cursor: pointer;
      box-shadow: -80px 0 0 80px #9a905d; /*filling up effect*/
    }
    .verticalSlider.on::-webkit-slider-thumb {    
      background-color: yellow;
      box-shadow: -80px 0 0 80px yellow; /*filling up effect*/
    }
    .verticalSlider.off::-webkit-slider-thumb {
      background-color: blue;
      box-shadow: -80px 0 0 80px blue; /*filling up effect*/
    }  
    /*.verticalSlider:hover::-webkit-slider-thumb {
      /*background-color: black;*/
    }*/

    .verticalSlider::-webkit-slider-runnable-track { 

    }

    h1 {
      color: var(--fontColor); 
    }
    .buttonName {
      color: var(--fontColor);
      font-size: 30px;
    }
    h2 {
      color:var(--fontColor);  
    }

    .column {
      float: left;
      width: 10%;
      padding: 5px;
    }

    /* Clearfix (clear floats) */
    .row::after {
      content: "";
      clear: both;
      display: table;
    }

    button {
      vertical-align: top;
      border-radius: var(--defautlRadiusVal);
      display: block;      
      transition-duration: var(--buttonTransition);
      border: 0px;
      width:  var(--buttonSize);
      height: var(--buttonSize);
      margin-left:0;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      display: inline-block;
      /*display: block;*/
      font-size: relative; /*var(--buttonFontSize);*/
      color:var(--fontColor);/*font color*/
      outline-offset: 4px;
      margin-left: var(--buttonGroupMargin);
      margin-right: var(--buttonGroupMargin);
      margin-bottom: var(--buttonGroupMargin);
      margin-top: var(--buttonGroupMargin);
    }
    button::after { 

  }
  button.on{
    background-color: var(--buttonOn);
    color: black;
    transition-duration: var(--buttonTransition);
  }
  button.off {
    background-color: var(--buttonOff);
    color: black; 
    transition-duration: var(--buttonTransition);
  }
  /*hover is sticky on iphone */
  @media (hover: hover) { 
    button:hover{
      background-color: grey; 
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s;  
    }
  }

  .btn-group button {
    vertical-align: top;
    
  }
  .btn-group button::after { 

  }
  .btn-group button.on{
    background-color: var(--buttonOn);
    color: black;
    transition-duration: var(--buttonTransition);
  }
  .btn-group button.off {
    background-color: var(--buttonOff);
    color: black; 
    transition-duration: var(--buttonTransition);
  }
  /*hover is sticky on iphone */
  @media (hover: hover) { 
    .btn-group button:hover{
      background-color: grey; 
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s;  
    }
  }

  .buttonBulb { 
   /*inherits from button class*/
  }
  .buttonBulb::after {
    background-color: rgba(255,255,255,255,0);
    content: "";
    clear: both;
    display: block;
    padding:10px;
    /*margin-left:30px;
    margin-right:30px;*/
    border: 0px solid #000000;
  }
  .buttonBulb.on::after{
    background-color: rgba(255,255,255,255,0);
    background-image: url("/lightOn.png");
    background-position: center;
    background-repeat: no-repeat;
    transition-duration: var(--buttonTransition);
  }
  .buttonBulb.off::after{
    background-color: rgba(255,255,255,255,0);
    background-image: url("/lightOff.png");
    background-position: center;
    background-repeat: no-repeat;
    transition-duration: var(--buttonTransition);
  }  
  @media (hover: hover) {
    .buttonBulb:hover { 
      background-color: rgba(255,255,255,255,0);   
      color: black;
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s; 
    }
    .buttonBulb:hover.off::after {
      background-color: rgba(255,255,255,255,0);
      background-position: right;
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s; 
    }
    .buttonBulb:hover.on::after {
      background-color: rgba(255,255,255,255,0);
      background-position: right;
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s; 
    }
  }

  
  .buttonContact::after {
    background-color: rgba(255,255,255,255,0);
    content: "";
    clear: both;
    display: block;
    padding:10px;
    margin-left:25px;
    margin-right:30px;
    border: 0px solid #000000;
  }
  .buttonContact.on::after{
    /*content:"open";
    align-content: center;*/
    color: red;
    background-color: rgba(255,255,255,255,0);
    background-image: url("/windowOpen.png");
    background-position: center;
    background-repeat: no-repeat;
    transition-duration: var(--buttonTransition);
  }
  .buttonContact.off::after{
    /*color: black;*/
    background-color: rgba(255,255,255,255,0);
    background-image: url("/windowClosed.png");
    background-position: center;
    background-repeat: no-repeat;
    transition-duration: var(--buttonTransition);
  }  
  @media (hover: hover) {
    .buttonContact:hover { 
      background-color: rgba(255,255,255,255,0);   
      color: black;
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s; 
    }
    .buttonContact:hover.off::after {
      background-color: rgba(255,255,255,255,0);
      background-image: url("/windowOpen.png");
      background-position: right;
      background-position: right;
      transition-duration: 0.5s; 
    }
    .buttonContact:hover.on::after {
      background-color: rgba(255,255,255,255,0);
      background-image: url("/windowClosed.png");
      background-position: right;
      background-position: right;
      transition-duration: 0.5s; 
    }
  }

  .buttonFan::after {
    background-color: rgba(255,255,255,255,0);
    content: "";
    clear: both;
    display: block;
    padding:20px;
    margin-left:20px;
    margin-right:30px;
    border: 0px solid #000000;
  }
  .buttonFan.on::after{
    color: red;
    background-color: rgba(255,255,255,255,0);
    background-image: url("/fan.gif");
    background-position: center;
    background-repeat: no-repeat;
    transition-duration: var(--buttonTransition);
  }
  .buttonFan.off::after{
    /*color: black;*/
    background-color: rgba(255,255,255,255,0);
    background-image: url("/fan.png");
    background-position: center;
    background-repeat: no-repeat;
    transition-duration: var(--buttonTransition);
  }  
  @media (hover: hover) {
    .buttonFan:hover { 
      background-color: rgba(255,255,255,255,0);   
      color: black;
      border-radius: var(--hoverRadiusVal);
      transition-duration: 0.5s; 
    }
    .buttonFan:hover.off::after {
      background-color: rgba(255,255,255,255,0);
      background-image: url("/fan.png");
      background-position: center;
      transition-duration: 0.5s; 
    }
    .buttonFan:hover.on::after {
      background-color: rgba(255,255,255,255,0);
      background-image: url("/fan.gif");
      background-position: center;
      transition-duration: 0.5s; 
    }
  }

  
  .headerButton {
    
    vertical-align: top;
    display: block;
    border-radius: var(--defautlRadiusVal);
    transition-duration: var(--buttonTransition);
    border: 0px;
    width: var(--buttonSize);
    height: var(--headerButtonHeight);
    margin-left:0;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    display: inline-block;
    /*display: block;*/
    font-size: 8px; /*var(--buttonFontSize);*/
    color:var(--fontColor);/*font color*/
    outline-offset: 4px;
    margin-left: var(--buttonGroupMargin);
    margin-right: var(--buttonGroupMargin);
    margin-bottom: var(--buttonGroupMargin);
    margin-top: var(--buttonGroupMargin);
  }
  
  .lockButton {    
    padding: 0px;    
    color: var(--fontColor);/*font color*/
    border-radius: 0px;
    border: 0px;
    width:  100px;
    height: 25px;
    margin-left:0;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    /*display: inline-block;*/
    font-size: 8px;
    outline-offset: 0px; 
  }
  .triangle-down {
    background-color: #ffffff;
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 50px solid var(--buttonColor);
  }
  .triangle-up:hover {
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-bottom: 50px solid #FAE454;
  }
  .triangle-down:hover {
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 50px solid #FAE454;
  }

  .text {
    vertical-align: top;
    padding: 0px;
    background-color: var(--buttonOn);
    color: black;
    border-radius: 0px;
    border: 0px;
    width:  25px;
    height: var(--headerButtonHeight);
    margin-left:0;
    text-align: inherit;
    text-decoration: none;
    cursor: pointer;
    /*display: inline-block;*/
    font-size: 8px;
    /*color:var(--fontColor);/*font color*/
    outline-offset: 4px;
 }
 .watttext {
  background-color: var(--backgroundColor); /*var(--buttonOff);*/
  border-radius: 0px;
  color: white;
  width: 160px;
  height: 25px;
  font-size: relative;

}
.headerspan {

  color: white;
  cursor: pointer;
}
</style>
<head>
  <center>  
    <h4 id="pageTitle" style="color:black; font-size: relative;">SMART HOME INTERFACE</h4>    
    <div id="locks"></div>
    <div>
      <input  class="text" id="refreshRate" value="" autofocus> 
      <button class="headerButton" style='text-align: left' id="submitBtnRefreshRate" onclick="defineShortRefreshRate()">set refresh rate</button>
    </div>
    <div>     
      <button class="headerButton" id="reload" onclick="backgroundCss(true)"> Change Theme </button>                  
      <button class="headerButton" id="homepower";> </button>
      <button class="headerButton" id="powerSwitches";> </button>
      <button class="headerButton" id="reload" onclick="location.reload()"> RELOAD </button> 
      <button class="headerButton" id="thermsotats" onclick="window.open('/thermostats.html','_blank')"> Thermostats </button> 
      <button class="headerButton" id="refreshALl" onclick="refreshAll('userRequest')"> REFRESH </button> 
      <button class="headerButton" id="debugbtn" onclick="toggleDebug()">DEBUG</button>
    </div>
  </center>
</head>

<body onload="init()">
  <center>
    <div id="divForMouseEvents">      
      <div class="btn-group" id="lights_buttons"></div>
      <div class="btn-group" id="buttons"></div>
      <div id="dimmers"></div>      
    </div>
  </center>
</body>
<script>

  /***************************************PREFERENCES*****************************/
var access_token = "access_token=d6699bb3-0d13-48d1-ab5d-8cc583efa76c" // enter your access token as 'access_token=xxxxxxxx-xxxx-xxxx-...';
var ip = "192.168.10.72" // enter your ip address as a string

//ADD YOU APP NUMBER 
var appNumber = "35" // YOU'LL FIND IT IN THE URL TEMPLATES PROVIDED INSIDE THE MAKER API APP'S SETTINGS
//SET YOUR PREFERENCES

var myPageTitle = "SMART HOME INTERFACE" 
var FirstStageRessourceSavingTimeout = 30; // time after which refresh rate starts slowing down to firstStageRessourceSavingInterval in seconds
var firstStageRessourceSavingInterval = 10; // first stage refresh rate in seconds
var FirstStageRessourceSavingTimeoutDone = false; // boolean that defines if first stage (FirstStageRessourcesavingtimeout) has been set yet
var RessourceSavingTime = 120; // in seconds ; refresh rate in power saving mode, scheduled as defined by the ressourceSavingTimeout variable
var ressourceSavingTimeout = 1; // in minutes ; time after which the refresh rate will go from first stage short interval to long interval ressource saving mode
var stopAllScripts = false; // set to true if you want all scripts to be stopped after a certain time
var stopAllScriptsTimeout = 2; // value in hours
var labelLength = 18; // max length of your devices' names (trimLabel(label, labelLength)


/****************DO NOT MODIFY ANYTHING BELOW THIS LINE!**************************/


/*************************************************INITIALIZATION*********************************************/
var version = 10 // all devices detect new versions and then reload to update

myPageTitle = `<h4 id='pageTitle' style='color:white'>`+myPageTitle+`<SPAN style='color:yellow' id='currentMode'></SPAN><br><SPAN class='headerspan' id='refreshRateMessage'></SPAN></br></h4>`

var lockState = "..."
var ShortRefreshTime = defineShortRefreshRate();// in seconds ; Beware of ressources. Too low of a value can render your hub inoperable
setRefreshInterval(false);
var RessourceSavingRefreshInterval = RessourceSavingTime 
var interval1; // refresh interval 
var interval2; // new interval after power saving mode has started
var interval3; 
var timeoutRessourceSaving = ""; // set the refresh intervals
var cmdLevel = "setLevel"
var cmdSwitch = "toggle";
var cmdLock = "lockToggle"
var id = ""; 
var listOfDevicesURL = "http://"+ip+"/apps/api/"+appNumber+"/devices/all?"+access_token;
var listOfModes = "http://"+ip+"/apps/api/"+appNumber+"/modes?/all?"+access_token;
var allDevices; 
var listString = "";
var sliderId = "sliderId"; // this var needs to be public
var nSId = 0; // this number needs to be public
var spanIdList = [] // this value must be public, will be updated here with nSId number
var allDevicesLabelsSorted = [];
var dimmerList = []
var lockList = []
var deviceCapabilities = [];
var mainPower = 0
var acPower = 0
var otherPowerSwitches = 0
var stopAddingMore = false
var thereIsAMainMeter = false
var backGroundModifiedByUser = false
inputRefreshRate = document.getElementById("refreshRate");
var buttonOff = getComputedStyle(document.body).getPropertyValue('--buttonOff');
var buttonOn = getComputedStyle(document.body).getPropertyValue('--buttonOn');
var buttonOnHover = buttonOff
var buttonOffHover = buttonOn
var backgroundColor   = window.navigator.userAgent.indexOf('iPhone') != -1 ? "darkblue" : getComputedStyle(document.body).getPropertyValue('--backgroundColor');
var backgroundColor2  = window.navigator.userAgent.indexOf('iPhone') != -1 ? "darkblue" : getComputedStyle(document.body).getPropertyValue('--backgroundColor2');
var backgroundColor3  = window.navigator.userAgent.indexOf('iPhone') != -1 ? "darkblue" : getComputedStyle(document.body).getPropertyValue('--backgroundColor3');
var backgroundColor4  = window.navigator.userAgent.indexOf('iPhone') != -1 ? "darkblue" : getComputedStyle(document.body).getPropertyValue('--backgroundColor4');
var backgroundColor5  = window.navigator.userAgent.indexOf('iPhone') != -1 ? "darkblue" : getComputedStyle(document.body).getPropertyValue('--backgroundColor5');
var backgroundColorSliderRamp = getComputedStyle(document.body).getPropertyValue('--backgroundColorSliderRamp');
var enableDebug = false;
var debugTimeout = 1; // in minutes
var called = 0; 
var lastPause = Date.now() // for logging()
const switchStateValues = new Map();
var loadCounter = 0;
var xhrErrors = 0;

if (window.navigator.userAgent.indexOf('iPhone') != -1) {
  if (window.navigator.standalone == true) {

  }else{
    alert("Tap the + button and choose 'Add to Home Screen'");
  }
}

function init(){
  // zoom()
  document.getElementById("pageTitle").innerHTML = "Loading data... "
  if(ValidateIPaddress(ip) == false)
  {
    alert("INCORRECT IP ADDRESS FORMAT! Please review your entry")
  }
  getAllDevicesData(listOfDevicesURL); 
  console.log ("page initialization..."); 
  initialized = false; // prevent refresh() from running before buttons are generated
  setTimeout(function(){buildButtons();}, 4000);    
}

function ValidateIPaddress(ipaddress) 
{  
  if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipaddress)) {  
    return (true)  
  }  
  ////logging("NOT AN IP ADDRESS");
  return (false);
};

function defineShortRefreshRate() 
{
  var newVar = document.getElementById("refreshRate").value;
  logging("newVar = "+newVar)
  var status = newVar == ""
  logging("newVar true/false ? "+status)
  if(newVar == "") // first boot on the device (computer or phone)
  {
    newVar = window.localStorage.getItem('storedRefreshRate'); // check if there's a stored value
    console.log("newVar local = "+newVar)
    var status2 = newVar == null
    logging("newVar status2 ? "+status2)
    if(newVar == null)
    {
      console.log("default 5 seconds refresh rate")
      return 5
    }
    else 
    {
       var newVarInt = parseInt(newVar) // stuck here, returns NaN... // found the solution: must be parsed as int before storage!
       console.log("returning user's stored value:"+newVarInt)
       return newVarInt
     }
   }
  else // this is a user custom request 
  {
    if(newVar == 1)
    {
      alert("Interval must be 2 or higher!")
      newVar = 2; // below 2 seconds, asynchronous requests go crazy and interval is less than 1 seconds for some reason (despite recent colde cleaning 3/21/2022). 
    }
    newVarStored = parseInt(newVar);
    window.localStorage.setItem('storedRefreshRate', newVarStored); // store the value on local storage
  }
  location.reload()
}
function checkVersion() 
{
 var v = window.localStorage.getItem('version')
 // console.log("stored version = "+v)
 if(v != version)
 {
  console.log("code needs to be updated, reloading")
  window.localStorage.setItem('version', version);
  location.reload()
 }
 
}

function backgroundCss(userRequest) // attempt to change the background with time of day... not working for now
{
  if(userRequest == true) { backGroundModifiedByUser = !backGroundModifiedByUser }

    var now = new Date();
  var currentHour = now.getHours()
  var currentMinutes = now.getMinutes()
  var currentSeconds = now.getSeconds()
  var multiplier = 60 * 60 * 1000
  var currentHourInMillis = currentHour  *  multiplier

  var after0  =  currentHourInMillis >= 0  * multiplier && currentHourInMillis < 6  * multiplier
  var after6  =  currentHourInMillis >= 6  * multiplier && currentHourInMillis < 12 * multiplier
  var after12 =  currentHourInMillis >= 12 * multiplier && currentHourInMillis < 20 * multiplier
  var after20 =  currentHourInMillis >= 20 * multiplier && currentHourInMillis < 22 * multiplier
  var after22 =  currentHourInMillis >= 22 * multiplier 

  var test = 22 * multiplier
  ////logging("after22="+after22+"   "+currentHourInMillis+"  "+test)
  //associative array
  var periodsMap = {"between 1h and  6h" : after0, "between 6h and 12h" : after6, "between 12h and 20h" : after12, "after 20h" : after20, "after 22h" : after22};

  //map
  /*var periodsMap = new Map([
    ["between 1h and  6h", after0],
    ["between 6h and 12h", after6],
    ["between 12h and 20h", after12],
    ["after 20h", after20]
    ]);*/
  //var currentPeriod = after0 ? "between 1h and  6h" : after6 ? "between 6h and 12h" : after12 ? "between 12h and 20h" : "after 20h"
  //see https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce 
  // to understand the reduce() method
  // a is the callback function executed once for each element and ignores empty elements. 
  var currentPeriod = Object.keys(periodsMap).reduce((a, c) => {
    if (periodsMap[c] === true) {
      currentPeriod = c
      ////logging("currentPeriod = "+currentPeriod)
    }
    return c
  }, []);
  
  var cssBody = ""
  var currentTime = currentHour + ":" + currentMinutes + ":" + currentSeconds + ":"
  var color;
  var colorDisplayName;
  if(!backGroundModifiedByUser && !userRequest)
  {
    ////logging("blob............")
    if(after0) {color = backgroundColor;colorDisplayName = Object.keys({backgroundColor})[0]} // Object.keys here allows to log the var name
    if(after6) {color = backgroundColor2;colorDisplayName = Object.keys({backgroundColor2})[0]}
    if(after12) {color = backgroundColor3;colorDisplayName = Object.keys({backgroundColor3})[0]}
    if(after20) {color = backgroundColor4;colorDisplayName = Object.keys({backgroundColor4})[0]}
    if(after22) {color = backgroundColor5;colorDisplayName = Object.keys({backgroundColor5})[0]}
    // console.log("current time period = "+currentPeriod+" now: "+currentTime+" color:"+colorDisplayName)
  }
  else if(userRequest)
  {
    //console.log("USER REQUEST")
    var colorsArray = [backgroundColor, backgroundColor2, backgroundColor3, backgroundColor4, backgroundColor5]
    color = colorsArray[Math.floor(Math.random()*colorsArray.length)]; // pick a color randomly    
  }  
  // console.log(color)
  colorDisplayName = color == backgroundColor ? "backgroundColor" : color == backgroundColor2 ?  "backgroundColor2" : color == backgroundColor3 ? "backgroundColor3" : color == backgroundColor4 ? "backgroundColor4" : color == backgroundColor5 ? "backgroundColor5" : "error"

  // ////logging("current time period = "+currentPeriod+" now: "+currentTime+" color:"+colorDisplayName)
  // console.log("colorDisplayName ="+colorDisplayName)
  document.body.style.background = color
}

function buildButtons()//
{   

  logging("buildButtons()")   
  if(allDevices == undefined) 
  {
    setTimeout(function() {buildButtons();}, 1000)
    console.log("No data yet... please wait")
    loadCounter++;
    if(loadCounter > 10)
    {
      location.reload();
    }
    return
  }

  loadCounter = 0

  setTimeout(function(){sliderEventListener();}, 2000); // must be called last for db to be updated
  setTimeout(function(){getMode();}, 2000);
  var checkModeInterval = setInterval(function(){getMode();}, 10000);  
  toggleDebug(true)

  document.getElementById("pageTitle").innerHTML = myPageTitle;
  setTimeout(function(){ setRefreshInterval(true); }, FirstStageRessourceSavingTimeout * 1000);
  setRefreshInterval(true); //set refresh interval
  setTimeout(function(){refresh("buildButtons()/init()");}, 3000);
  
  var s = allDevices.length;
  var lasti = i; 
  var lastiLights = i;   
  var device = "";
  var deviceId = "";
  var html = "";  
  var x = "";
  var lights = "";
  var someDimmers = false
  var labelSorted = "";
  var idSorted    = "";
  var deviceCapabilitiesSorted = "";
  var allDevicesLabels = [];
  var thereIsLight;

  for (var i = 0; i < s ; i++) 
  {
    labelSorted = allDevices[i].label;
    idSorted    = allDevices[i].id;    
    deviceCapabilitiesSorted = allDevices[i].capabilities; // is an array
    allDevicesLabels.push([labelSorted, idSorted, deviceCapabilitiesSorted]);
  }

  allDevicesLabelsSorted = allDevicesLabels.sort(); // update global variable with this array
  lights = x;
  s = allDevicesLabelsSorted.length; // should be same size but never mind... 
  i = 0;
  var k = i;  
  var deviceCount = 0; // we need a separate iteration counter here as to not affect the layout when the device is not a button (dimmers)
  var kL = i;
  var deviceCountLighs = 0;

  // console.log(JSON.stringify(allDevices))

  // BIG PROBLEM TO FIX HERE IT'S ALL MIXED UP ID's, labels, etc. 
  for (i=0; i < s ; i++) 
  {
    // listString += allDevices[i].name;
    var deviceLabel = allDevicesLabelsSorted[i][0]; // don't use allDevicesLabels here, not in same order as allDevicesLabelsSorted  
    var originalLabel = deviceLabel  
    var deviceLabel = trimLabel(deviceLabel, labelLength);
    var deviceLabel = deviceLabel.toLowerCase();    
    var deviceId = allDevicesLabelsSorted[i][1]; //listOfDevicesURL returns ONLY id, name, label and type.     
    var deviceCapabilities = allDevicesLabelsSorted[i][2];// so in order to get capabilities we need to use a different function using the proper url
    var id = deviceId; 

    var isSwitch = deviceCapabilities.find(element => element == "Switch") == "Switch"
    var isDimmer = deviceCapabilities.find(element => element == "SwitchLevel") == "SwitchLevel"
    var isPowerMeter = deviceCapabilities.find(element => element == "PowerMeter") == "PowerMeter"
    var isLock = deviceCapabilities.find(element => element == "Lock") == "Lock"
    var isContact = deviceCapabilities.find(element => element == "ContactSensor") == "ContactSensor"
    var isLight = deviceLabel.includes("light")
    var level = isDimmer ? allDevices[i].attributes.level : null
    

    //console.log("isContact ? "+isContact)

    /*********************************/
    if(isLock)
    {
      someLocks = true // confirm existence of locks for later construction
      lockList.push([deviceId, deviceLabel])
    }
    else if(isSwitch || isDimmer) // find SwitchLevel in capabilities 
    {

      if(isDimmer)
      {

        // console.log(deviceLabel+" is a dimmer")
        nSId++;
        var spanSliderId = "spanId"+nSId; // create a unique ID for this slider value text span
        deviceIdLevelButton = deviceId+"button"; // id of the corresponding on/off button of the dimmer
        someDimmers = true // confirm existence of dimmers for later construction
        spanIdList.push([deviceId, spanSliderId, deviceLabel]); // public list updated for later slider.value update
        dimmerList.push([deviceId, deviceLabel, spanSliderId, deviceIdLevelButton])
        
        deviceId = deviceId+"dimmer"
        if(isContact)
        {
          deviceCount++
          x += `          
          <button id='`+deviceId+`' onclick='toggleDevice(cmdSwitch,id)'>`+deviceLabel.toLowerCase()+`</button>
          `; 
        }
        else if(isLight)
        {
          deviceCountLighs++
          thereIsLight = true 
          lights +=  `          
          <button id='`+deviceId+`'onclick='toggleDevice(cmdSwitch,id)'>`+deviceLabel.toLowerCase()+`</button>
          `;  
        }
        else 
        {
          deviceCount++
          x += `          
          <button id='`+deviceId+`'onclick='toggleDevice(cmdSwitch,id)'>`+deviceLabel.toLowerCase()+`</button>
          `;  
        }
      }
      else 
      {
        if(isLight)
        {
          deviceCountLighs++ 
          thereIsLight = true 
          lights +=  `          
          <button id='`+deviceId+`'onclick='toggleDevice(cmdSwitch,id)'>`+deviceLabel.toLowerCase()+`</button>
          `;  
        }
        else 
        {
          deviceCount++
          x += `          
          <button id='`+deviceId+`' onclick='toggleDevice(cmdSwitch,id)'>`+deviceLabel.toLowerCase()+`</button>
          `;  
        }
      }  
    }
    k = deviceCount - lasti
    kL = deviceCountLighs - lastiLights  
    // if((deviceCount == max || k == max) || (deviceCountLighs == max || kL == max)) // new row every 4 columns
    // {      
    //   if(isLight == true)
    //   {
    //     lastiLights = deviceCountLighs
    //     lights += "</tr><tr>";
    //   }
    //   else
    //   {
    //     lasti = deviceCount;
    //     x += "</tr><tr>"; // new row and horizontal line
    //   }
    // }     
  }
  
  
  if(thereIsLight)
  {
    x = lights + x
    // document.getElementById("lights_buttons").innerHTML = lights
  }

  // x += "</tr></table>"  

  document.getElementById("buttons").innerHTML = x;

  if(someDimmers) // needs to be built separatelty so as to have different max number of objects per row
  {
   x = buildDimmers(dimmerList)
   document.getElementById("dimmers").innerHTML = x;  

  }
  if(someLocks)
  {
     x = buildLocks(lockList)
    document.getElementById("locks").innerHTML = x;
  } 


 initialized = true;     
}

function getAllDevicesData(url)//
{
  //console.log("getAllDevicesData(url) "+url)
  allDevices;
  var xhr = new XMLHttpRequest;       
  xhr.onreadystatechange = function() 
  {
    if (xhr.readyState == 4)
    {
      if(xhr.status == 200) 
      {
        allDevices = JSON.parse(xhr.responseText);  
      }
      else
      {
        xhrErrors++;
        console.log("----------Error--------", xhr.statusText);
        if(xhrErrors >= 20)
        {
          location.reload();
        }  
        return        
      }
        //if(callback) callback(allDevices); // could never get this to really work so far... need to figure this out
      };
    };
    xhr.open("GET", url, true);
    xhr.send();
  };

  function trimLabel(label, length)
  {
    label = label.replace("on Home 1", "");
    label = label.replace("on Home 2", "");
    label = label.replace("on Home 3", "");
    label = label.replace("on HOME 1", "");
    label = label.replace("on HOME 2", "");
    label = label.replace("on HOME 3", "");
    label = label.replace("temperature", "temp.")
    label = label.replace("Temperature", "temp.")

    if(label.length > length)
    {
     label =  label.substr(0, length);
   }
   return label 
 }

 function buildDimmers(dimmerList, lasti, maxDimmers)
 {
  ////logging("buildDimmers()")

  var i = 0
  var s = dimmerList.length
  logging("dimmerList length="+s)
  var a = ""

  for(i=0;i<s;i++)
  {
    //dimmerList.push([deviceId, deviceLabel, spanSliderId,deviceIdLevelButton])
    deviceId = dimmerList[i][0]
    deviceLabel = dimmerList[i][1]
    spanSliderId = dimmerList[i][2]
    deviceIdLevelButton = dimmerList[i][3]

      a += `
      <li class="column">
        <span class="sliderSpanName" >`+deviceLabel+`</span>
      
        <span class="sliderSpanVal" id=`+spanSliderId+`></span>
      
        <input class='verticalSlider' type='range' min='0' max='99' step='1' id='`+deviceId+`' onchange='setLevel(id, value)'>
      </li>
      `;
    
    }

    initialized = true;
    return a   
  }

  function buildLocks(lockList, lasti, maxLocks)
  {
    console.log("buildLocks()")
    var i = 0
    var s = lockList.length
    var b = "<tr>"
    for(i=0;i<s;i++)
    {

      deviceId = lockList[i][0]
      console.log("buidling lock id:"+deviceId)
      deviceLabel = lockList[i][1]   
      b += `    
      <th><button class="lockButton" id='`+deviceId+`'onclick='toggleLock(cmdLock, id, true)'></button></th>`;       
                
    }

    if(i==(maxLocks-1) || i==lasti+maxLocks) // new row every 4 columns
    {
      lasti = i;
      b += "</td><td class='lockButton'>"; // new row and horizontal line
    } 
    b += "</tr>"
    return b   
  };

/*************************************************END OF INITIALIZATION*********************************************/

function clearLocalStorage()
{
  window.localStorage.clear();
  ////logging("data cleared");
  location.reload();
}

function getMode()
{

  var xmlhttp = new XMLHttpRequest();
  var listOfModesURL = "http://"+ip+"/apps/api/"+appNumber+"/modes?"+access_token
  var listOfModes = ""
  ////logging("http://"+ip+"/apps/api/"+appNumber+"/modes?"+access_token)
  //"http://"+ip+"/apps/api/1348/modes?access_token=8b5615ed-43a6-4318-bd88-af5f1e2c30bd"
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
      var listOfModes = JSON.parse(this.responseText);
        ////logging("list of modes: "+JSON.stringify(listOfModes))
        var currentMode = "";
        var s = listOfModes.length
        
        for(var i = 0;i<s;i++) // find the active:true value 
        {
          var entry =  listOfModes[i]
          ////logging("entry: "+JSON.stringify(entry))

          if(entry.active == true)
          {
            currentMode = " ("+entry.name.toLowerCase()+")"
          ////logging("Current Mode is:"+entry.name)
        }
      }
      if(currentMode == "")
      {
        currentMode = "error"
      }
      document.getElementById("currentMode").innerHTML = currentMode
    }
  };
  xmlhttp.open("GET", listOfModesURL, true);
  xmlhttp.send();
}

/******************************* VALUES UPDATES AND REFRESH *****************************/
function updateButton(id, value, calledBy, label, type, secondType) 
{
  //console.log(id+" "+value+" "+calledBy+" "+label+" "+type+" "+secondType)  
  ////logging("device id:"+id+" is:"+value+" ,label:"+label+", calledBy:"+calledBy+", type:"+type);
  //background-color: url(/lightOff.png) no-repeat;
  var cssImage = "";
  var cssBackground = "";
  var cssHover = "";
  var cssTextColor = "";
  var buttonToChange = ""; 
  var buttonToChange = document.getElementById(id)
  
  var style = document.createElement('style');

  if(buttonToChange == null)
  {
    console.log("failed to get element for "+label+"'s id("+id+") (a)")
    return 
  }
  label = trimLabel(label, labelLength)
  
  if(type == "lock")
  {
    buttonToChange.style.fontSize="12px";
    if(lockState == "locked")
    {
      //logging(label+" is "+lockState)
      buttonToChange.style.background="#FD0808" //     
      buttonToChange.style.color="white"
      buttonToChange.style.opacity="1"
    }
    else if(lockState == "unlocked")
    {
      //logging(label+" is "+lockState)
      buttonToChange.style.background="#F7F2F2" //
      buttonToChange.style.color="black"
      buttonToChange.style.opacity="1"
    }
    //logging(label+" is "+lockState)
    document.getElementById(id).innerHTML = label+" is "+lockState; 
  }
  else if(type == "button")
  {
    if(value == "on")
    {
      label = label.toLowerCase()
      if(label.includes("light")) // check if it's a light
      {        
        buttonToChange.className="buttonBulb on"; // change the light buld image by changing its class within the btn group
      }
      else if(label.includes("fan"))
      {
        buttonToChange.className="buttonFan on";
      }
      else if(secondType == "contact")   
      {
        buttonToChange.className="buttonContact on"; 
        buttonToChange.innerHTML = label+"\n (open)"
      }            
      else
      {
        buttonToChange.className="button on"; // allows to apply new button:hover colors
      }
      
      //buttonToChange.style.color="black"      
    }
    else if(value == "off") // if device has no value yet we still need to create its style so it can be appended below
    {
      label = label.toLowerCase()
      if(label.includes("light")) // check if it's a light
      {  
        buttonToChange.className="buttonBulb off"; // change the light bulb image by changing its class within the btn group
      }
      else if(label.includes("fan"))
      {
        buttonToChange.className="buttonFan off";
      }
      else if(secondType == "contact")   
      {
        buttonToChange.className="buttonContact off";
        buttonToChange.innerHTML = label+"\n (closed)"
      }  
      else
      {
        buttonToChange.className="button off"; // allows to apply new button:hover colors
      }
      
    }  
  }
  if(type == "dimmer") 
  {
    // logging("id:"+id+" label:"+label+" isSlider: "+isSlider+" value:"+value)
    if(value == "off")
    {
      buttonToChange.className="verticalSlider off";
    }
    else 
    {
      buttonToChange.className="verticalSlider on"
    }
  }
}

function refreshAll(origin){
  checkVersion();
  console.log("refreshAll("+origin+")")
  getAllDevicesData(listOfDevicesURL) //listOfDevicesURL, function(allDevices){}); // callback() method
  setTimeout(function(){refresh("fromRFA")}, 500); // give time for data collection due to the asyncrhonus nature of ajax. 
}
function refresh(origin)
{
  //console.log("refresh("+origin+")")

  if(allDevices == undefined) 
  {
    setTimeout(function() {refreshAll("watchdog");}, 1000)
    console.log("No data... ")
    loadCounter++;
    if(loadCounter > 4)
    {
      location.reload();
    }
    
    return
  }
  loadCounter = 0

  
  var s = allDevices.length;
  // var s = allDevicesLabelsSorted.length;
  //alert(allDevicesLabelsSorted);
  ////logging("********************* LIST SIZE: "+s)
  var lasti = i;  
  var device = "";
  var deviceId = "";
  var a = 0;
  var b = 0
  mainPower = 0
  otherPowerSwitches = 0

  for (var i = 0; i < s ; i++) 
  {
    var myObj = allDevices[i]
    //console.log(JSON.stringify(myObj))
    var SwitchState = myObj.attributes.switch
    var level = myObj.attributes.level 
    var ObjCapabilities = myObj.capabilities    
    var deviceLabel = trimLabel(myObj.label, labelLength);
    deviceLabel = deviceLabel.toLowerCase();
    var deviceId = myObj.id; 
    var deviceType = "unknown"   
    var size = myObj.attributes.length;
    var hasSwitchCapability = ObjCapabilities.find(element => element == "Switch") == "Switch"  
    var hasPowerCapability = ObjCapabilities.find(element => element == "PowerMeter") == "PowerMeter" 
    var hasSwitchLevelCapability = ObjCapabilities.find(element => element == "SwitchLevel") == "SwitchLevel" 
    var isLock = ObjCapabilities.find(element => element == "Lock")

    //console.log(deviceLabel+" hasSwitchLevelCapability ? "+hasSwitchLevelCapability)
    //console.log(ObjCapabilities)

    if(deviceId == null)
    {
      console.log("failed to get element for "+label+"'s id '"+id+"' (refresh)")
    }  
    else 
    {
      if(isLock) // is it a lock ? 
      {
        var state = myObj.attributes.lock
        lockState = state
        // console.log(deviceLabel+" is "+state+" deviceId = "+deviceId)
        deviceType = "lock"      
        document.getElementById(deviceId).innerHTML = deviceLabel+" is "+state;       
        updateButton(deviceId, state, "refresh()",deviceLabel, deviceType, myObj.type);
      }    
      else if(hasPowerCapability && hasSwitchCapability)
      {
        deviceType = "meterSwitch"
        var powerVal = myObj.attributes.power
        if(powerVal != null)
        {
          if(powerVal != null) otherPowerSwitches += parseInt(powerVal)
          //console.log(deviceLabel+" IS POWER METER val = "+powerVal+" Watts")
        document.getElementById("powerSwitches").innerHTML = "Switches:"+parseInt(otherPowerSwitches)+"W";
        if(powerVal != null) document.getElementById(deviceId).innerHTML = deviceLabel+" is "+parseInt(powerVal)+"W"; 
          updateButton(deviceId, SwitchState, "refreshAll()", deviceLabel, "button", myObj.type);  // it's a switch so has to be updated as button type
          switchStateValues.set(deviceId, [deviceLabel, deviceType, SwitchState, level]); // store devices states for instantaneous button color update in toggledevice()
          logging("index "+i+": "+deviceLabel+" powerVal = "+powerVal+" total is:"+otherPowerSwitches)
        }
        else
        {
          logging(deviceLabel+" powerVal is null - deviceId is:"+deviceId);
        }
      }
      else if(hasPowerCapability && !hasSwitchCapability)
      {
        deviceType = "mainMeter"
        var powerVal = myObj.attributes.power
        if(powerVal != null)      
        {
          mainPower +=  powerVal
          logging("-----------MAIN POWER METER DETECTED val = "+powerVal+" Watts")
          document.getElementById("homepower").innerHTML = "Home:"+parseInt(mainPower)+"W"
        }
        else
        {
          console.log(deviceLabel+" powerVal is null - deviceId is:"+deviceId);
        }
      }
      else if(hasSwitchLevelCapability) // is it a dimmer ? 
      {
        deviceType = "dimmer"
        refreshSlider(deviceId, level, deviceLabel); 
        updateButton(deviceId, SwitchState, "refreshAll()", deviceLabel, deviceType, myObj.type);
        switchStateValues.set(deviceId, [deviceLabel, deviceType, SwitchState, level]); // store devices states for instantaneous button color update in toggledevice()
        
        var thisId = deviceId+"dimmer"
        deviceType = "button"
        var secondType = ObjCapabilities.find(element => element == "ContactSensor") ? "contact" : "buttonDimmer"
        updateButton(thisId, SwitchState, "refreshAll()", deviceLabel, deviceType, secondType);
      }
      else if(hasSwitchCapability) // is it a switch ? 
      {
        deviceType = "button"
        updateButton(myObj.id, SwitchState, "refreshAll()", deviceLabel, deviceType, secondType);
        switchStateValues.set(deviceId, [deviceLabel, deviceType, SwitchState, level]); // store devices states for instantaneous button color update in toggledevice()   
      }
    }       
      // console.log("a="+a+"/"+i);
      // console.log("b="+b+"/"+i); 
    }


    backgroundCss(false);
  // console.log("allDevices = "+JSON.stringify(allDevices));
  // console.log(switchStateValues);
};

function refreshSlider(deviceId, value, label)
{
  var s = spanIdList.length;
  var spanId = ""; 
  var buttonId = "" // object id of the button onto wich we want to display the device name + its value in %
  var buttonName = "" // just for display purpose, not an object id... 
  for(var i = 0;i<s;i++)
  {
    if(spanIdList[i][0] == deviceId){

      spanId = spanIdList[i][1];
      buttonName = spanIdList[i][2];
    }
  }

  if(spanId == "" || spanId == null || deviceId == null)
  {
    console.log("failed to get element for "+label+"'s id("+id+") (e)")
    return
  }  
    //console.log("label:"+label+" spanId:"+spanId+" deviceId:"+deviceId+" value:"+value)
    document.getElementById(spanId).innerHTML = value; // update span number value
    document.getElementById(deviceId).value = value;// update the value displayed on the slider}
  }

  /******************************* DEVICE COMMANDS**************************************/
  function setLevel(id, value)
  {
  setRefreshInterval(false); // resume normal interval
  //logging(value+" "+id);
  
  var data = switchStateValues.get(id) // we collect last values to append the level value to this device's last states
  var lastLabel = data[0]
  var lastDeviceType = data[1]
  var LastSwitchState = data[2]
  var newLevel = value

  
  if(value == 0 || value == "toggle"){
    value = 1 //for some reason, hubitats' level devices will go back to previous level value if set to 0 from here... 
    newLevel = 1
  }

  switchStateValues.set(id, [lastLabel, lastDeviceType, LastSwitchState, newLevel]); // "newLevel" is the data that is being updated here

  if(value != "toggle") // toggle is not a level value, don't send crap to the hub... 
  {
    try {
    // device accepting "toggleDevice" command
    var url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"/setLevel/"+value+"?"+access_token;
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() 
    {
      if (this.readyState == 4 && this.status == 200) 
      {
      };
    };    

    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  }
  catch(err)
  {
    alert("TEST!")
  }
}
setTimeout(function(){setValueOneToggle(id, value)}, 2000)
}

function setValueOneToggle(id, value){

  if(value == 1) toggleDevice("off", id)
    if(value == "toggle") toggleDevice("toggle", id)
  }

function toggleDevice(cmd, id) 
{
  setRefreshInterval(false); // resume normal interval
  
  var trueId = id.includes("dimmer") ? id.replace("dimmer", "") : id // if id = xxDimmer, then we need to keep the true id for the http request
  
  var data = switchStateValues.get(id);
  //console.log("data = "+data)
  if(data != null)
  {
    //switchStateValues.set(deviceId, [deviceLabel, deviceType, SwitchState, level]); // retrieved stored device's state for instantaneous button color update 
    var deviceLabel   = data[0] 
    var deviceType    = data[1]
    var LastSwitchState = data[2] 
    var LastLevel   = data[3]

    //console.log("previousState data = "+data)
    var newState = LastSwitchState != null && deviceType == "button" ? LastSwitchState == "off" ? "on" : "off" :"false"

    console.log("newState = "+newState)
    if(newState != "false")
    {
      console.log("UPDATING BUTTON")
      if(deviceType == "button") 
      {
        updateButton(id, newState, "toggleDevice()", deviceLabel, deviceType, "");
      }
    }
    setTimeout(function(){refreshAll("toggle");}, 1000)
  }
  

  var url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+trueId+"/"+cmd+"?"+access_token;    
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
    };
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();
};


function toggleLock(cmd, id)
{
  var value = lockState // get the last state
  ////logging("lock id:"+id+" is "+value)
  if(value == null || value == undefined) 
  {
      ////logging("REQUEST STOPPED")
      return 
    }
    var lockCMD = value == "locked" ? "unlock" : "lock"
  ////logging("sending lock cmd: "+lockCMD)
  var url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"/"+lockCMD+"?"+access_token;    
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
    };
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();

  getAllDevicesData(listOfDevicesURL) //listOfDevicesURL, function(allDevices){}); 
  setTimeout(function(){refresh("toggleLock")}, 2000);
}

/*******************************END OF DEVICE COMMANDS**************************************/
input.addEventListener("keyup", function(event) {
  if (event.keyCode === 13) {
   event.preventDefault();
   document.getElementById("submitBtn").click();
 }
});
inputRefreshRate.addEventListener("keyup", function(event) {
  if (event.keyCode === 13) {
    event.preventDefault();
    document.getElementById("submitBtnRefreshRate").click();
  }
});

function handleDragStart(e){
  this.style.opacity = '0.4';
}
function handleDragEnd(e){
  this.style.opacity = '1'
}
let items = document.querySelectorAll('.container .box');
items.forEach(function (item) {
  item.addEventListener('dragstart', handleDragStart);
  item.addEventListener('dragend', handleDragEnd);
});

document.getElementById("divForMouseEvents").addEventListener("mousemove", function(event) {
  setRefreshInterval(false); // resume normal interval
});

function sliderEventListener()
{
  // create an event listener for all sliders inputs, if any
  var b = spanIdList.length;
  var n = 0;
  ////logging("b = "+b+" n = "+n);
  for (b != 0; n < b; n++ ) { 
    //[deviceId, spanSliderId]  
    var slider = spanIdList[n][0]; // slider object id
    var output = spanIdList[n][1]; // span object that shows the value number
    ////logging("creating listener for "+slider+" && "+output);
    var rangeInput = document.getElementById(spanIdList[n][0]);    
    rangeInput.addEventListener("input", sliderOutput(slider, output, n), false);
  };
}

function sliderOutput(sliderObj, spanObj, n)
{
  var buttonName = spanIdList[n][2];
  var deviceLabel = spanObj;
  //logging(buttonName+" "+deviceLabel+" spanObj is:"+spanIdList[n][1])
  var slider = document.getElementById(sliderObj);
  var output = document.getElementById(spanObj);
  //var output2 = document.getElementById(buttonId);

  //logging(buttonName+"slider value: "+slider.value+"%")
  
  output.value = slider.value; // update the slider position
  output.innerHTML = slider.value;// update span number dispayed value // we actually prefer to keep the value as modified with cursor otherwise we get the last value and the new value will appear only after next refresh cycle. 
  
  slider.oninput = function() //allows to see changes as the cursor is being moved
  {
    //updates cursor and number value once input done
    output.value = slider.value; // update the slider position
    output.innerHTML = this.value;// update span number dispayed value     
    // ////logging("slider.value is:"+slider.value);
    // ////logging("deviceId:"+sliderObj+"button");
    //document.getElementById(sliderObj).value = slider.value//;// update the value displayed on the slider}
    if(slider.value == 0 || slider.value == 1)
    {
      //document.getElementById(sliderObj+"button").innerHTML = "off"; // we do this with colors so as to keep the device name on the button
      var calledBy = "sliderOutput 524"
      updateButton(sliderObj, "off", calledBy, deviceLabel, "dimmer", "dimmer");
    }
    else
    {
      //document.getElementById(sliderObj+"button").innerHTML = "on"; // we do this with colors so as to keep the device name on the button
      var calledBy = "sliderOutput 895"
      updateButton(sliderObj, "on", calledBy, deviceLabel, "dimmer", "dimmer");
    }
  }
};  

/******************************* INTERVALS AND TIMEOUTS MANAGEMENT*************************/
function setRefreshInterval(clear)
{  
  var refreshState = "NA";
  var refInterval = 0;
  //return 

  if(clear != true) // short interval - set at boot then after resume from saving modes
  {
    clearAllIntervals()
    console.log("Short ressource interval")
    refInterval = ShortRefreshTime * 1000;
    FirstStageRessourceSavingTimeoutDone = false; // allow for first stage ressource saving interval
    interval1 = setInterval(function(){refreshAll("interval1");}, refInterval);
    timeoutRessourceSaving = setTimeout(function(){ setRefreshInterval(true); }, FirstStageRessourceSavingTimeout * 1000); // reset timeout
  }
  else if(clear == true && FirstStageRessourceSavingTimeoutDone != true) // first stage ressource saving
  {
    clearAllIntervals()
    console.log("First stage ressource interval")
    refInterval = firstStageRessourceSavingInterval * 1000;
    FirstStageRessourceSavingTimeoutDone = true; // remember this is done
    interval2 = setInterval(function(){refreshAll("interval2");}, refInterval); // set interval refresh of n seconds
    timeoutRessourceSaving = setTimeout(function(){ setRefreshInterval(true); }, ressourceSavingTimeout * 1000 * 60); // schedule the next refresh intervals
  }
  else if(clear == true) //Ressourcesaving mode
  {    
    refInterval = RessourceSavingRefreshInterval * 1000;
    clearAllIntervals()  
    interval3 = setInterval(function(){refreshAll("interval3");}, refInterval); // set interval refresh of n seconds
    console.log("Long ressource interval")
  }
  
  refreshState = "\n refresh rate is "+refInterval/1000+" seconds"; // value to display on top of the page
  // console.log(refreshState)
  var ob = document.getElementById("refreshRateMessage")
  if(ob != undefined) ob.innerHTML = refreshState;  

  if(stopAllScripts == true && stopAllScriptsTimeout != 0)
  {
    setTimeout(function(){clearAllIntervals();}, stopAllScriptsTimeout * 1000 * 60 * 60)
    clearTimeout(timeoutRessourceSaving);
    logging("All scripts will be stopped after "+stopAllScriptsTimeout+" hours");
  }
}

function clearAllIntervals()
{
  clearInterval(interval1);
  clearInterval(interval2);
  clearInterval(interval3);
}


/******************************************* CAPABILITIES BOOLEANS ***************************/

function checkDimmer(cap) // checks if device has SwitchLevel capability
{ 
  return cap == "SwitchLevel";
}

function checkSwitch(cap) // checks if device has SwitchLevel capability
{ 
  return cap == "Switch";
};

function checkLock(cap) // checks if device has lock capability
{ 
  return cap == "Lock";
};

function checkPowerMeter(cap) // checks if device has powerMeter capability
{
 return cap == "PowerMeter";
}

/*function isDimmer(id)
{
  ////logging("dimmerList length="+dimmerList.length)
  for(var i = 0;i<dimmerList.length;i++)
  {
    var thisId = dimmerList[i][0]
    var matchId = thisId == id 
    ////logging("thisId = "+thisId+"(index:"+i+")")
    if(matchId)
    {
      //logging(thisId+" device is a dimmer!")
      return true
    }
  }
  return false 
}*/

/******************************************* DEBUG ***************************/
function toggleDebug(startCmd)
{
  enableDebug = startCmd ? false : !enableDebug
  var debugStatus = enableDebug ? "DEBUG IS ON" : "DEBUG IS OFF"
  if(enableDebug == true)
  {
    setTimeout(function(){ toggleDebug(true); }, debugTimeout * 1000 * 60); 
  }
  else {
    //console.clear();
  }
  document.getElementById("debugbtn").innerText = debugStatus
}
function logging(message)
{
  if(enableDebug == true)
  {
    var maxDebug = 1000
    called+=1
    if(called < maxDebug)
    {
      console.log(message)
    }
    else if(called == maxDebug)
    {
      lastPause = Date.now()
      setTimeout(() => {
        const millis = Date.now() - lastPause;
        console.clear();
        console.log ("called reset");
        called = 0;
      }, 2000);
    }    
  }
}
function zoom() {
            document.body.style.zoom = "100%" 
        }
</script>
</html>