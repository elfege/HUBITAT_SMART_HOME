<!DOCTYPE html>
<html>
<head>
  <title>SMART HOME INTERFACE</title>  
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="initial-scale=1.0">
  <meta name="viewport" content="maximum-scale=1.0">
  <meta name="viewport" content="user-scalable=no">
  <meta name="viewport" content="width=device-width">
  <link rel="apple-touch-icon-precomposed" href="http://elfege.com/penrose.jpg">
  <link rel="apple-touch-startup-image" href="http://elfege.com/penrose.jpg">

  <style>
  :root {
    --buttonSize:80px;
    --buttonGroupMargin: 5px;
    --sliderSpanTDmarginLEFT: 5px; 
    --sliderSpanTDmarginRIGHT: 7px; 
    --sliderLength: 180px; /*buttonSize x 2 */
    --sliderWidth: 30px;
    --buttonFontSize:relative;
    --fontSize:8px;
    --fontColor:#0B0B0A;
    --buttonColor:#64AEB1;

    --backgroundColor: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 33%, rgba(0,212,255,1) 100%);
    --backgroundColor2: linear-gradient(45deg, #F1F116, #D5D536, #B6B644, #92921C, #E0310E); 
    --backgroundColor3: linear-gradient(45deg,#06DCF3,#067FF3);
    --backgroundColor4: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(63,184,154,1) 0%, rgba(0,212,255,1) 100%);
    --backgroundColor5: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(84,75,141,1) 0%, rgba(0,212,255,1) 100%);
    --backgroundColorSliderRamp: red;

    --buttonOffHover: #E9F614; /*"linear-gradient(45deg, #F1F116, #D5D536, #B6B644, #92921C, #E0310E)";*/
    --buttonOnHover: #1D1E1A; /*"linear-gradient(45deg, #5E6060, #517979, #3E9D9D, #31BCBC, #18A2E0)";*/ 
    --buttonOff: #1D1E1A;     /*"linear-gradient(45deg, #5E6060, #517979, #3E9D9D, #31BCBC, #18A2E0)";*/ 
    --buttonOn:  #E9F614;     /*"linear-gradient(45deg, #F1F116, #D5D536, #B6B644, #92921C, #E0310E)";*/
  }
  body {
    /*background-image: url("/img1.jpg");*/
    /*background-repeat: no-repeat;*/
    background-size: 100% 100%;
    background: var(--backgroundColor);
    height: 100vh;
    margin: 0;
    background-attachment: fixed;
    opacity: 1;
  }
  table {
    width:100%;
    border: 0px;
    padding: 0px;
    text-align: center;
    /*background-color:var(--backgroundColor);*/
    /*background: rgba(255,255,255,0);*/
    opacity: 1;
  }
  tr {
    border: 0px solid grey;
  }
  td {
    border: 0px solid grey;
  }
  .buttonTD {
    width:var(--buttonSize);
    border: 0px solid white;
    padding: 0px;
    text-align: center;
    background-color:var(--backgroundColor);
    opacity: 1;
  }
  .sliderTable {
    width:var(--sliderLength);
    border: 1px solid white;
    padding: 0px;
    text-align: center;
    background-color:var(--backgroundColor);
    opacity: 1;
    margin-left: var(--sliderSpanTDmarginLEFT);
    margin-right: var(--sliderSpanTDmarginRIGHT);
  }
  .SpanSliderTable {
    width:var(--sliderLength);
    height: var(--buttonSize);
    border: 0px solid white;
    padding: 0px;
    text-align: center;
    background-color:var(--backgroundColor);
    background: dimgrey;
  }
  .sliderTD {
    width:var(--sliderLength);
    height: 200px;
    border: 0px solid white;
    padding: 0px;
    text-align: center;
    background-color:var(--backgroundColor);
    opacity: 1;
  }
  .sliderPanTD {
    width:var(--sliderLength);
    height: 20px;
    border: 0px solid white;
    padding: 0px;
    text-align: center;
    background-color:var(--backgroundColor);
    opacity: 1;
  }

  .sliderSpanName {
    font-size: 10px;
    font-weight: bold;
    color: white;
    opacity: 1;
    
  }
  .sliderSpanVal {
    font-size: 10px;
    font-weight: bold;
    color: yellow;
    
  }

  
  .innerTable {
    border:0px solid white;
    border-radius:0px;
    padding:0px;
  }
  h1 {
    color: var(--fontColor); 
  }
  .buttonName {
    color: var(--fontColor);
    font-size: 30px;
  }
  h2 {
    color:var(--fontColor);  
  }

  /*MUST BE IDENTICAL TU BUTTONBULB CLASS*/
  button {
    background: rgba(255,255,80,1);/*rgba(76,82,105,0.6);*/
    border-radius: 15px;
    border: 0px;
    width:  var(--buttonSize);
    height: var(--buttonSize);
    margin-left:0;
    text-align: center;
    text-decoration: none;
    color:rgba(0,0,0,1); /*text*/
    cursor: pointer;
    /*display: inline-block;*/
    font-size: relative; /*var(--buttonFontSize);*/
    color:var(--fontColor);/*font color*/
    outline-offset: 4px;
    /*opacity: 0.5;*/
    margin-left: var(--buttonGroupMargin);
    margin-right: var(--buttonGroupMargin);
    margin-bottom: var(--buttonGroupMargin);
    margin-top: var(--buttonGroupMargin); 
  }
  button:hover{
    /*background-color: #A6EE13;*/
    color: black;
    border-radius: 10px;
    transition-duration: 1s;  
  }
  button:hover:after{
    content: "";
    clear: both;
    /*display: block;
    padding:15px;*/
    border: 0px solid #000000; 
  }
  button:hover.on:after{
    /*content: "turn off";*/
    background-color: #B9C8C8;
    color: white;
    border-radius: 0px;
    transition-duration: 1s;  
  }
  button:hover.off:after{
    /*content: "turn on";*/
    background-color: #FFC258;
    color: white;
    border-radius: 0px;
    transition-duration: 1s; 
  }
  .buttonBulb { /*MUST BE IDENTICAL TU BUTTON CLASS*/
    background: rgba(76,82,105,0.6);
    border-radius: 15px;
    border: 0px;
    width:  var(--buttonSize);
    height: var(--buttonSize);
    margin-left:0;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    font-size: relative; 
    color:var(--fontColor);
    outline-offset: 4px;
    margin-left: var(--buttonGroupMargin);
    margin-right: var(--buttonGroupMargin);
    margin-bottom: var(--buttonGroupMargin);
    margin-top: var(--buttonGroupMargin);
  }
  .buttonBulb::after {
    background-color: rgba(255,255,255,255,0);
    content: "";
    clear: both;
    display: block;
    padding:10px;
    margin-left:30px;
    margin-right:30px;
    border: 0px solid #000000;
  }
  .buttonBulb.on::after{
    background-color: rgba(255,255,255,255,0);
    background-image: url("/lightOn.png");
    background-repeat: no-repeat;
  }
  .buttonBulb.off::after{
    background-color: rgba(255,255,255,255,0);
    background-image: url("/lightOff.png");
    background-repeat: no-repeat;
  }  
  .buttonBulb:hover { 
    background-color: rgba(255,255,255,255,0);   
    color: black;
    border-radius: 0px;
    transition-duration: 0.5s; 
  }
  .buttonBulb:hover.off::after {
    background-color: rgba(255,255,255,255,0);
    border-radius: 0px;
    transition-duration: 0.5s; 
  }
  .buttonBulb:hover.on::after {
    background-color: rgba(255,255,255,255,0);
    border-radius: 0px;
    transition-duration: 0.5s; 
  }
  .btn-group button {
    background-color: rgba(255,255,255,255,0);
    color: var(--fontColor); /* text color */
    padding: 0px 0px; /* Some padding */
    
    cursor: pointer; /* Pointer/hand icon */
    float: center; /* Float the buttons side by side */
    opacity: 1;
  }  
  .btn-group::after { /*Clear floats (clearfix hack) */
    background-color: rgba(255,255,255,255,0);
    content: "";
    clear: both;
    display: table;
    padding:15px;
    border: 0px solid #000000;
  }
  .btn-group button:not(:last-child) {
    border-right: none; /* Prevent double borders */
  }  
  .btn-group button:hover { /* Add a background color on hover */
    background-color: var(--buttonOffHover);
    color: #D11F1F; /* text color */
    border-radius: 20px;
    transition-duration: 1s; 
  }
  .headerButton {
    padding: 0px;
    background-color: var(--backgroundColor);
    color: white;
    border-radius: 0px;
    border: 0px;
    width:  100px;
    height: 25px;
    margin-left:0;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    /*display: inline-block;*/
    font-size: 12px;
    /*color:var(--fontColor);/*font color*/
    outline-offset: 4px;

  }
  
  .lockButton {    
    padding: 0px;
    color: black;
    border-radius: 2px;
    border: 0px;
    width:  100px;
    height: 25px;
    margin-left:0;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    /*display: inline-block;*/
    font-size: 8px;
    color:var(--fontColor);/*font color*/
    outline-offset: 4px; 
  }

  .triangle-down {
    background-color: #ffffff;
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 50px solid var(--buttonColor);
  }
  .triangle-up:hover {
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-bottom: 50px solid #FAE454;
  }
  .triangle-down:hover {
    width: 0;
    height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 50px solid #FAE454;
  }

.verticalSlider {
  -webkit-appearance: none;
  transform: rotate(270deg);
  width: var(--sliderLength);
  height: var(--sliderWidth);
  background-color: white;
  border-radius: 0px;
}
.verticalSlider::after {
}
.verticalSlider.on {
  background-color: var(--backgroundColorSliderRamp);
}
.verticalSlider.off {
  background-color: grey;
}
.verticalSlider::-webkit-slider-thumb {   
  -webkit-appearance: none;
  transform: rotate(270deg);
  width: 50px;
  height:25px;
  background-color: white;
  border-radius: 0px;
}
 
.text {
   /*background: url("http://elfege.com/penrose.jpg") no-repeat;*/
  padding: 0px;
  background-color: white; /*var(--buttonColor);*/
  color: black;
  border-radius: 0px;
  border: 0px;
  width:  25px;
  height: 25px;
  margin-left:0;
  text-align: center;
  text-decoration: none;
  cursor: pointer;
  display: inline-block;
  font-size: 15px;
  color:var(--fontColor);/*font color*/
  outline-offset: 4px;
}
.watttext {
  background-color: var(--backgroundColor); /*var(--buttonOff);*/
  border-radius: 0px;
  color: white;
  width: 160px;
  height: 25px;
  font-size: 14px;

}
.headerspan {
  
  color: white;
  cursor: pointer;
}



</style>
<head>
  <center>   
   <table>  
      <tr style="padding:0px">  
        <td>
          <h4 style="color:white">SMART HOME INTERFACE <SPAN style="color:yellow" id="currentMode"></SPAN><SPAN class="headerspan" id="stopscript"> refreshing </SPAN></h4>
          
          <button class="headerButton" id="reload" onclick="location.reload()"> RELOAD </button>
          <button class="headerButton" id="refreshALl" onclick="refreshAll()"> REFRESH </button>   
          <button class="lockButton" id="locks"></button>       
          <button class="watttext" id="homepower";> </button>
          <button class="headerButton" id="thermsotats" onclick="window.open('http://192.168.10.15/thermostats.html','_blank')"> Thermostats </button>
        </td>
      </tr> 
      
    </table>
  </center>
</head>

<body onload="init()">
  <center>
    <div id="buttons"></div>
    <div id="dimmers"></div>
    <table>
      <tr>
        <td><button class="watttext"  id="acpower";> </button></td>
        <td><button class="watttext" id="otherpowerswitches";> </button></td>
        <td><button class="headerButton" onclick="clearLocalStorage()">default (4)</button></td>   
      </tr> 
      <tr>
        <td>
          <input class="text" id="buttonsPerRow" value="">
          <button class="headerButton" id="submitBtn" onclick="defineButtonVar()">Set # of Col.</button>
        </td>
      </tr>
    </table>
  </center>
</body>
<script>
/***************************************CUSTOMIZABLE SECTION*****************************/
//ADD YOUR NEW ACCESS TOKEN HERE AS SUCH : "access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
// YOU WILL FIND IT IN HUBITAT'S "Maker API" app.
var access_token = "access_token=b95d97c7-8746-47a5-8e48-13829ae76c18" //"access_token=ae3f6fe1-10d5-44b9-841c-81ef66260314";
var ip = "192.168.10.70"

//ADD YOU APP NUMBER // YOU'LL FIND IT IN THE URL TEMPLATES PROVIDED BY THE APP
var appNumber = "1683" //"1035";
//SET YOUR PREFERENCES
var refreshTime = 3;// in seconds ; Beware of ressources. Too low of a value can render your hub inoperable 
var powerSavingTime = 30; // in seconds ; refresh rate in power saving mode, scheduled as defined by the powerSavingTimeout variable
var powerSavingTimeout = 1; // in minutes ; time after which the refresh rate will go into power saving mode
var stopAllScripts = false; // set to true if you want all scripts to be stopped after a certain time
var stopAllScriptsTimeout = 2; // value in hours


/****************DO NOT MODIFY ANYTHING BELOW THIS LINE!**************************/


/*************************************************INITIALIZATION*********************************************/
var lockState = "..."
var max = defineButtonVar(); //  number of buttons per row
var refreshInterval = refreshTime * 1000; // seconds
var powerSavingRefreshInterval = powerSavingTime * 1000; // seconds
var interval1 = "" // refresh interval 
var interval2 = "" // new interval after power saving mode has started
var timeoutPowerSaving = setTimeout(function(){ setRefreshInterval(true); }, powerSavingTimeout * 1000 * 60); // set the refresh intervals
var maxDimmers = max != 1 ? max % 2 == 0 ? max/2 : (max-1)/2 : max ; // check max is even, if not, retract 1, unless it's set to 1 
var cmdLevel = "setLevel"
var cmdSwitch = "toggle";
var cmdLock = "lockToggle"
var id = ""; 
var isRefreshing = false;
var listOfDevicesURL = "http://"+ip+"/apps/api/"+appNumber+"/devices/all?"+access_token;
var listOfModes = "http://"+ip+"/apps/api/"+appNumber+"/modes?/all?"+access_token;
var allDevices = getAllDevices(); // will be replaced by allDevicesLabelsSorted
var listString = "";
var sliderId = "sliderId"; // this var needs to be public
var nSId = 0; // this number needs to be public
var spanIdList = [] // this value must be public, will be updated here with nSId number
var allDevicesLabelsSorted = [];
var dimmerList = []
var lockList = []
var powerMeters = []
var deviceCapabilities = [];
var mainPower = 0
var acPower = 0
var otherPowerSwitches = 0
var stopAddingMore = false
var thereIsAMainMeter = false
var input = document.getElementById("buttonsPerRow");
var mylatesttap;
var PrepToggleDeviceTimeout;
var backgroundColor  = "linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 33%, rgba(0,212,255,1) 100%)";
var backgroundColor2 = "linear-gradient(45deg, #F1F116, #D5D536, #B6B644, #92921C, #E0310E)"; 
var backgroundColor3 = "linear-gradient(45deg,#06DCF3,#067FF3)";
var backgroundColor4  = getComputedStyle(document.body).getPropertyValue('--backgroundColor4');
var backgroundColor5  = getComputedStyle(document.body).getPropertyValue('--backgroundColor5');
var backgroundColorSliderRamp = getComputedStyle(document.body).getPropertyValue('--backgroundColorSliderRamp');

input.addEventListener("keyup", function(event) {
  if (event.keyCode === 13) {
   event.preventDefault();
   document.getElementById("submitBtn").click();
  }
});

if (window.navigator.userAgent.indexOf('iPhone') != -1) {
  if (window.navigator.standalone == true) {

  }else{
    alert("Tap the + button and choose 'Add to Home Screen'");
  }
}
else
{
  //normal browser, set a time limit to refresh()
  //setTimeout(function(){ setRefreshInterval(true); }, 1 * 3600 * 1000); // clear all intervals after 1 hour
  //console.log("running sliderEventListener in 5000ms");
}

function init(){

  console.log ("page initialization..."); 
  //getAllDevices();
  buildButtons();
  //sliderEventListener();
  setTimeout(function(){refreshAll();}, 4000);    
  setTimeout(function(){sliderEventListener();}, 5000); // must be called last for db to be updated
  setRefreshInterval(false); //set interval refresh
  console.log("INITIALIZATION DONE");  
}

function ValidateIPaddress(ipaddress) 
{  
  if (/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipaddress)) {  
    return (true)  
  }  
  //console.log("NOT AN IP ADDRESS");
  return (false);
};

function defineButtonVar() 
{
  var newVar = document.getElementById("buttonsPerRow").value;
  //console.log("newVar = "+newVar)
  var status = newVar == ""
  //console.log("newVar true/false ? "+status)
  if(newVar == "") // first boot on the device (computer or phone)
  {
    newVar = window.localStorage.getItem('butPerRow'); // check if there's a stored value
    console.log("newVar local = "+newVar)
    var status2 = newVar == null
    //console.log("newVar status2 ? "+status2)
    if(newVar == null)
    {
      console.log("4 buttons per row")
      return 4
    }
    else 
    {
       var newVarInt = parseInt(newVar) // stuck here, returns NaN... // found the solution: must be parsed as int before storage!
       console.log("returning user's stored value:"+newVarInt)
       return newVarInt
    }
  }
  else // this is a user custom request 
  {
    newVarStored = parseInt(newVar);
    window.localStorage.setItem('butPerRow', newVarStored); // store the value on local storage
  }
  location.reload()
}

function backgroundCss() // attempt to change the background with time of day... not working for now
{
  var now = new Date();
  var currentHour = now.getHours()
  var currentMinutes = now.getMinutes()
  var currentSeconds = now.getSeconds()
  var multiplier = 60 * 60 * 1000
  var currentHourInMillis = currentHour  *  multiplier

  var after1  =  currentHourInMillis > 1  * multiplier && currentHourInMillis < 6  * multiplier
  var after6  =  currentHourInMillis > 6  * multiplier && currentHourInMillis < 12 * multiplier
  var after12 =  currentHourInMillis > 12 * multiplier && currentHourInMillis < 20 * multiplier
  var after20 =  currentHourInMillis > 20 * multiplier && currentHourInMillis < 22 * multiplier
  var after22 =  currentHourInMillis > 22 * multiplier 


  //associative array
  var periodsMap = {"between 1h and  6h" : after1, "between 6h and 12h" : after6, "between 12h and 20h" : after12, "after 20h" : after20, "after 22h" : after22};

  //map
  /*var periodsMap = new Map([
    ["between 1h and  6h", after1],
    ["between 6h and 12h", after6],
    ["between 12h and 20h", after12],
    ["after 20h", after20]
    ]);*/

  //var currentPeriod = after1 ? "between 1h and  6h" : after6 ? "between 6h and 12h" : after12 ? "between 12h and 20h" : "after 20h"
  
  //see https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce 
  // to understand the reduce method
  // a is the callback function executed once for each element and ignores empty elements. 
  var currentPeriod = Object.keys(periodsMap).reduce((a, c) => {
    if (periodsMap[c] === true) {
      currentPeriod = c
      console.log("currentPeriod = "+currentPeriod)
    }
    return c
  }, []);
  

  var cssBody = ""
  var currentTime = currentHour + ":" + currentMinutes + ":" + currentSeconds + ":"
  
  
  //console.log("current time period = "+currentPeriod+" now: "+currentTime)


  if(after1) {document.body.style.background = backgroundColor} 
  if(after6) {document.body.style.background = backgroundColor2}
  if(after12) {document.body.style.background = backgroundColor3}
  if(after20) {document.body.style.background = backgroundColor4}
  if(after22) {document.body.style.background = backgroundColor5}
    

 /* if (style.styleSheet) {
    style.styleSheet.cssText = cssHover;
  } else {
    style.appendChild(document.createTextNode(cssBody));
  }*/
}

/*************************************************END OF INITIALIZATION*********************************************/

function clearLocalStorage()
{
  window.localStorage.clear();
  console.log("data cleared");
  location.reload();
}

function getAllDevices()
{
  //console.log("getAllDevices() URL = "+listOfDevicesURL)
  var xmlhttp = new XMLHttpRequest();
  
  xmlhttp.onreadystatechange = function() {

    if (this.readyState == 4 && this.status == 200) {

      //console.log("qualifying content");
      allDevices = JSON.parse(this.responseText);
      allDevices = allDevices.sort(); // useless as such devices being numbers
    };
  };
  xmlhttp.open("GET", listOfDevicesURL, true);
  xmlhttp.send();
}

function getMode()
{
  var xmlhttp = new XMLHttpRequest();
  var listOfModesURL = "http://"+ip+"/apps/api/"+appNumber+"/modes?"+access_token
  var listOfModes = ""
  //console.log("http://"+ip+"/apps/api/"+appNumber+"/modes?"+access_token)
  //"http://"+ip+"/apps/api/1348/modes?access_token=8b5615ed-43a6-4318-bd88-af5f1e2c30bd"
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
      var listOfModes = JSON.parse(this.responseText);
        //console.log("list of modes: "+JSON.stringify(listOfModes))
        var currentMode = "";
        var s = listOfModes.length
        
        for(var i = 0;i<s;i++) // find the active:true value 
        {
          var entry =  listOfModes[i]
          //console.log ("entry: "+JSON.stringify(entry))

         if(entry.active == true)
         {
          currentMode = "("+entry.name.toLowerCase()+")"
          //console.log("Current Mode is:"+entry.name)
        }
      }
      if(currentMode == "")
      {
        currentMode = "error"
      }
      document.getElementById("currentMode").innerHTML = currentMode
    }
  };
  xmlhttp.open("GET", listOfModesURL, true);
  xmlhttp.send();
}

function refreshAll()
{
  var s = allDevicesLabelsSorted.length;
  //alert(allDevicesLabelsSorted);
  //console.log("********************* LIST SIZE: "+s)
  var lasti = i;  
  var device = "";
  var deviceId = "";
  for (var i = 0; i < s ; i++) 
  {
    //get the device id from the public var allDevicesLabelsSorted created when the page loaded
    deviceLabel = allDevicesLabelsSorted[i][0];
    deviceId = allDevicesLabelsSorted[i][1]; //listOfDevicesURL returns ONLY id, name, label and type. 
    //console.log ("///////////////// device_id = "+deviceId)

    // now use this id to get last recent events for this specific device
    // NOT GOOD CAN RETURN OTHER EVENTS THAN ON/OFF OR LEVEL url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+deviceId+"/events?"+access_token; // recent events URL where id is spelled "device_id"
    //"http://"+ip+"/apps/api/"+appNumber+"/devices/2213/events?"+access_token

    url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+deviceId+"?"+access_token;
    //http://"+ip+"/apps/api/"+appNumber+"/devices/1956? +access_token     
    var xmlhttp = new XMLHttpRequest();
    
    var value = "";    

    xmlhttp.onreadystatechange = function() 
    {
      if (this.readyState == 4 && this.status == 200) 
      {
        var myObj = JSON.parse(this.responseText);
        value = myObj.attributes[0].currentValue;
        //console.log ("parse myObj = "+myObj.id+" iteration #"+i+" value="+value);
        var initialValue = value;
        var ID = myObj.id; 
        //console.log(myObj.label+" "+"("+myObj.id+") is currently : "+value);
        var deviceType = "button"      
        var a = 0; 
        var size = myObj.attributes.length;
        ////console.log(myObj.label+" ATTRIBUTES = "+size);

        for(a=0; a < size ; a++)// try all indexes until attribute's name is "level"
        { 

          value = myObj.attributes[a].currentValue // get the current value as "on" or "off" for this index

          if(myObj.attributes[a].name == "level") // but first check for a value that might be a level value
          {
            deviceType = "dimmer"
            ////console.log("LEVEL FOUND for "+myObj.label+"="+value);
            refreshSlider(myObj.id, value, myObj.label); 
          }
          else 
          {
            deviceType = "button"
          }
        }
       
       // when it's a dimmer the value found in this iteration is not an on/off string so, search for it
       if(value != "on" && value != "off")
        { 
          a = 0;
          for(a=0; a < size ; a++) 
          {
            // if no level attribute was found, continue unitl you get on/off att.
            // if we didn't find what we were looking for, it could be something else than a dimmer
            // returning values at the same index as a usual switch that are not switch values   

            var newValue = myObj.attributes[a].currentValue
            //console.log("RefreshALL device name: "+myObj.label+" value found: "+newValue);
            if(newValue == "on" || newValue == "off") //&& myObj.attributes[a].name != "level")
            {
              value = newValue;     
            }
            // if no break, it means we're dealing with a device that has its on/off attributes stored at a different index
          }
        }
        var NAME = myObj.name
        var NAMELowerCase = NAME.toLowerCase()
        if(NAMELowerCase.includes("thermostat"))
        {
          //console.log("**************isgnoring data for "+NAMELowerCase)
        }
        else 
        {
          updateButtonColor(myObj.id, value, "refreshAll()", myObj.label, deviceType, myObj.type);
        }  
      }
    };
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  }
  refreshLocks();
  getMode();
  updatePowerMeters();
  backgroundCss();
};

function getData(id, customID)
{
 
  console.log("getting data for id:"+id);
  // this url gets the device id's datasheet with attributes
  url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"?"+access_token;    
  var xmlhttp = new XMLHttpRequest();
  //var listOfCapabilities = [];
  var value = "";
  xmlhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var myObj = JSON.parse(this.responseText);
      value = myObj.attributes[0].currentValue
        if(myObj.type.includes("Aeotec"))
        {
          // old bad Z-wave shit, needs refresh
          console.log("REFRESHING AEOTEC DEVICES")
          toggleDevice("refresh", id, true)  
        }

        //console.log(myObj.label+" is : "+value)     
        if(value != "on" && value != "off")
        {
          //console.log("*************************");
          var a = 0; 
          var size = myObj.attributes.length;

        for(var a=0; a < size ; a++){ // try all indexes until currentValue returns either on or off 

          value = myObj.attributes[a].currentValue

          if(value == "on" || value == "off")
          {
            //console.log("////////////// FOUND VALUE = "+value);
            break;
          }
        }
      }
      if(customID)
      {
        // reconstruct the custom ID
        id = id+"button";        
        //console.log("updating "+myObj.label+"'s value")
        //document.getElementById(id).innerHTML = value; // deprecated, now we rely on colors only
      }
      // when not a dimmer, the on/off value isn't updated so buttons keep their names
      var calledBy = "getData 524"
      updateButtonColor(id,value, calledBy, myObj.label, myObj.type, myObj.type); 
    }
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();
  ////console.log("getData returns: "+value)
  //return value;
};

function logDimmerList()
{
  var list = JSON.stringify(dimmerList)
  console.log("dimmerList = "+list)
}






function buildButtons()
{
  console.log("buildButtons()")
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {

      //console.log("qualifying content");
      allDevices = JSON.parse(this.responseText);
      //allDevices = allDevices.sort(); // useless as such devices being numbers
      var s = allDevices.length;
          
      var lasti = i;  
      var device = "";
      var deviceId = "";
      var html = "";
      
      var x = "";
      var someDimmers = false

      var labelSorted = "";
      var idSorted    = "";
      var deviceCapabilitiesSorted = "";

      //console.log("allDevices = "+allDevices);

      //create a sorted list of all devices labels
      var allDevicesLabels = [];
      for (var i = 0; i < s ; i++) 
      {
        labelSorted = allDevices[i].label;
        idSorted    = allDevices[i].id;
        deviceCapabilitiesSorted = allDevices[i].capabilities; // is an array
        allDevicesLabels.push([labelSorted,idSorted,deviceCapabilitiesSorted]);
      }
      allDevicesLabelsSorted = allDevicesLabels.sort(); // update global variable with this array
      //console.log("allDevicesLabelsSorted = "+allDevicesLabelsSorted);

      x += "<table class='innerTable'><tr class='buttonTD'>"
      s = allDevicesLabelsSorted.length; // should be same size but never mind... 
      i = 0;
      var k = i;
      
      var deviceCount = 0 // we need a separate iteration counter here as to not affect the layout when the device is not a button (dimmers)
      for (i=0; i < s ; i++) 
      {
        // listString += allDevices[i].name;
        deviceLabel = allDevicesLabelsSorted[i][0]; // don't use allDevicesLabels here, not in same order as allDevicesLabelsSorted
        
        deviceLabel = trimLabel(deviceLabel, 18);

        deviceLabel = deviceLabel.toLowerCase();
        
        deviceId = allDevicesLabelsSorted[i][1]; //listOfDevicesURL returns ONLY id, name, label and type. 

        ////console.log("device id requested = "+deviceId);
        // so in order to get capabilities we need to use a different function using the proper url
        deviceCapabilities = allDevicesLabelsSorted[i][2];
        ////console.log("deviceCapabilities = " + deviceCapabilities)
        //console.log("creating button : "+deviceLabel+" id:"+deviceId);

        id = deviceId; 

        if(deviceCapabilities.find(checkPowerMeter))
        {
          //console.log(deviceLabel+" has PowerMeter capability")
          powerMeters.push([deviceId, deviceLabel])
        }
        /*********************************/
        
        if(deviceCapabilities.find(checkLock))
        {
          someLocks = true // confirm existence of locks for later construction
          lockList.push([deviceId, deviceLabel])
        }
        else if(deviceCapabilities.find(checkDimmer)) // find SwitchLevel in capabilities 
        {
          someDimmers = true // confirm existence of dimmers for later construction
          //console.log("someDimmers set to "+someDimmers)
          nSId++;
          var spanSliderId = "spanId"+nSId; // create a unique ID for this slider value text span
          deviceIdLevelButton = deviceId+"button"; // id of the corresponding on/off button of the dimmer
         
          spanIdList.push([deviceId, spanSliderId, deviceLabel]); // public list updated for later slider.value update
          dimmerList.push([deviceId, deviceLabel, spanSliderId, deviceIdLevelButton])

        }
        else if(deviceCapabilities.find(checkSwitch))
        {
          deviceCount++

          x += `          
            <td class="buttonTD" style="padding:3px"><button id='`+deviceId+`'onclick='toggleDevice(cmdSwitch,id, true)'>`+deviceLabel.toLowerCase()+`</button><td>
          `;           
        }
        else
        {
          //console.log(deviceLabel+" is nor a switch nor a dimmer, nor a lock...")
        } 
        k = deviceCount - lasti  
        if(deviceCount == max || k == max) // new row every 4 columns
        {
          lasti = deviceCount;
          x += "</tr><tr>"; // new row and horizontal line
        } 

      }
      x += "</tr></table>"
      
      document.getElementById("buttons").innerHTML = x;

      if(someDimmers) // needs to be built separatelty so as to have different max number of objects per row
      {
       //console.log("some dimmers...")
       x = buildDimmers(dimmerList, lasti=0, maxDimmers)
       document.getElementById("dimmers").innerHTML = x;
       
      }
      if(someLocks)
      {
       //console.log("some dimmers...")
       x = buildLocks(lockList, lasti=0, max)
       document.getElementById("locks").innerHTML = x;
      }      
    }
  };
  xmlhttp.open("GET", listOfDevicesURL, true);
  xmlhttp.send();
};

function trimLabel(label, length)
{
  label = label.replace("on Home 1", "");
  label = label.replace("on Home 2", "");
  label = label.replace("on Home 3", "");
  label = label.replace("on HOME 1", "");
  label = label.replace("on HOME 2", "");
  label = label.replace("on HOME 3", "");
  label = label.replace("temperature", "temp.")
  label = label.replace("Temperature", "temp.")

  if(label.length > length)
  {
   label =  label.substr(0, length);
  }
  return label 
}

function buildDimmers(dimmerList, lasti, maxDimmers)
{
  console.log("buildDimmers()")

  var i = 0
  var k = i
  var s = dimmerList.length
  //console.log("dimmerList length="+s)
  var style = getComputedStyle(document.body)
  var w = style.getPropertyValue('--buttonSize'); 
  console.log("w value = "+w)
  var a = "<table><tr>"

  for(i=0;i<s;i++)
  {
    //dimmerList.push([deviceId, deviceLabel, spanSliderId,deviceIdLevelButton])
    deviceId = dimmerList[i][0]
    deviceLabel = dimmerList[i][1]
    spanSliderId = dimmerList[i][2]
    deviceIdLevelButton = dimmerList[i][3]

    //console.log("building dimmer: "+deviceLabel)

    a += `
    <td>
      <table class="sliderTable">        
          <tr>
            <td class="sliderPanTD">
                <table class="SpanSliderTable">
                  <tr>
                    <td class="sliderPanTD"><span class="sliderSpanName" >`+deviceLabel.toUpperCase()+`</span></td>
                  </tr>
                  <tr>
                    <td class="sliderPanTD"><span class="sliderSpanVal" id=`+spanSliderId+`></span></td>
                  </tr>
                </table>
            </td>
          </tr>
          <tr>
            <td class="sliderTD">  
              <input class='verticalSlider' type='range' min='0' max='100' step='1' id='`+deviceId+`' onchange='setLevel(id, value)'>
            </td>
          </tr>      
      </table>
    </td>
    `;
  k = i - lasti
  if(i==maxDimmers-1 || k == maxDimmers) // new row every 4 columns
        {
      lasti = i;
      console.log("maxDimmers = "+maxDimmers+ " i = "+i+" k = "+k)
      a += "</tr><tr>"; // new row 
    } 
  }
  a += "</tr></table>"

  return a   
}
function buildLocks(lockList, lasti, maxLocks)
{
  console.log("buildLocks()")
  var i = 0
  var s = lockList.length
  //console.log("lockList length="+s)
  //console.log("*************lockList = "+lockList)
  var b = "<tr class='btn-group'>"
  //"http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"/"+cmd+"?"+access_token;
  //http://"+ip+"/apps/api/1348/devices/2519/lock?access_token=8b5615ed-43a6-4318-bd88-af5f1e2c30bd
  
  for(i=0;i<s;i++)
  {
    deviceId = lockList[i][0]
    deviceLabel = lockList[i][1]    
    b += `    
    <button class="lockButton" id='`+deviceId+`'onclick='toggleLock(cmdLock, id, true)'></button>`;           
  }   
  if(i==(maxLocks-1) || i==lasti+maxLocks) // new row every 4 columns
  {
    lasti = i;
    b += "</td><td class='lockButton'>"; // new row and horizontal line
  } 
  b += "</tr>"
  return b   
};

/******************************* VALUES UPDATES AND REFRESH *****************************/
function updateButtonColor(id, value, calledBy, label, type, typeOject) 
{

  //console.log("device id:"+id+" is:"+value+" ,label:"+label+", calledBy:"+calledBy+", type:"+type);
  //background: url(/lightOff.png) no-repeat;
  var cssImage = "";
  var cssBackground = "";
  var cssHover = "";
  var cssTextColor = "";
  var buttonToChange = ""; 
  var buttonOff = "#B9C8C8";
  var buttonOn = "#FFC258" ;//"#D7E009";
  var buttonOnHover = buttonOff
  var buttonOffHover = buttonOn

  var style = document.createElement('style');
  if(type == "dimmer")
  {
    //console.log("type is dimmer ----------------")
  }
  var isSlider = isDimmer(id) || id.includes("button") || type == "dimmer" // will include "button" only when page is freshly loaded
  var buttonToChange = document.getElementById(id)

  label = trimLabel(label, 10)
  var isLock = false
  if(typeOject != undefined){
    // console.log("typeOject= "+typeOject)
    isLock = typeOject.toLowerCase().includes("lock")
    if(isLock)
    {
      //console.log(label+" is a lock!")
    }
  }

  if(isLock)
  {
    buttonToChange.style.fontSize="12px";
    if(lockState == "locked")
    {
      //console.log(label+" is "+lockState)
      buttonToChange.style.background="#FD0808" //     
      buttonToChange.style.color="white"
      buttonToChange.style.opacity="1"
    }
    else if(lockState == "unlocked")
    {
      //console.log(label+" is "+lockState)
      buttonToChange.style.background="#F7F2F2" //
      buttonToChange.style.color="black"
      buttonToChange.style.opacity="1"
    }
    //console.log(label+" is "+lockState)
    document.getElementById(id).innerHTML = label+" is "+lockState; 
  }
  else if(!isSlider)
  {
    if(value == "on" || value == null)
    {
      for(var i = 0;i<allDevices.length;i++)
      {
        if(allDevices[i].id == id) // find within all devices the one with this id in order to get its label
        {
          //console.log("allDevices[i].label = "+allDevices[i].label)
          var label = JSON.stringify(allDevices[i].label).toLowerCase()
          if(label.includes("light")) // check if it's a light
          {            
            buttonToChange.className="buttonBulb on"; // change the light buld image by changing its class within the btn group

          }
          else
          {
            buttonToChange.className="button on"; // allows to apply new button:hover colors
          }        
        }
      }
      buttonToChange.style.background=buttonOn
      buttonToChange.style.color="black"      
    }
    else if(value == "off" || value == null) // if device has no value yet we still need to create its style so it can be appended below
    {
      
      for(var i = 0;i<allDevices.length;i++)
      {
        if(allDevices[i].id == id) // find within all devices the one with this id
        {
          //console.log("allDevices[i].label = "+allDevices[i].label)
          var label = JSON.stringify(allDevices[i].label).toLowerCase()
          if(label.includes("light")) // check if it's a light
          {
            buttonToChange.className="buttonBulb off"; // change the light bulb image by changing its class within the btn group
          }
          else
          {
            buttonToChange.className="button off"; // allows to apply new button:hover colors
          }
        }
      }
      buttonToChange.style.background=buttonOff
      buttonToChange.style.color="black"    
    }
  }
  else if(isSlider) // if it's a button attached to a slider, make sure to restore its original smaller style size
  {
    if(id.includes("button"))
    {
        //console.log("DEPRECATED REQUEST calledBy:"+calledBy+" for device: "+label+" id:"+id)
        // deprecated feature, do nothing
    }
    else
    {
      //console.log("id:"+id+" label:"+label+" isSlider: "+isSlider+" value:"+value)
      //console.log(label)
      if(value == "off")
      {
         // console.log("changing "+label+"'s color: "+buttonOff+"(OFF)")
        //buttonToChange.type.rangeInput= "background: "+buttonOff // apply the "off" color 
        //document.querySelector('range').style.setProperty('track-background', buttonOff);
        //buttonToChange.className="input[type=range] off";
        buttonToChange.className="verticalSlider off";
      }
      else 
      {
         // console.log("changing "+label+"'s color: "+buttonOn+"(ON)")
        //buttonToChange.type.rangeInput = "background: "+buttonOn
        //document.querySelector('range').style.setProperty('track-background', buttonOn);
        //buttonToChange.className="input[type=range] on"; // apply the "on" color too
        buttonToChange.className="verticalSlider on"

      }
    }
  }
}

/******************************* DEVICE COMMANDS**************************************/
function setLevel(id, value)
{
  clearTimeout(PrepToggleDeviceTimeout); // it's dimmer event, clear toggle detection
  setRefreshInterval(false); // resume normal interval
  console.log(value+" "+id);
  // device accepting "toggleDevice" command
  var url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"/setLevel/"+value+"?"+access_token;
  //http://"+ip+"/apps/api/"+appNumber+"/devices/2598/setLevel/10?+access_token

  //http://"+ip+"/apps/api/1348/devices/2631/setLevel/75?access_token=8b5615ed-43a6-4318-bd88-af5f1e2c30bd
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
    };
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();

  setTimeout(function(){getData(id)}, 1000);
}

function toggleDevice(cmd, id, feedBackLoop) 
{
  setRefreshInterval(false); // resume normal interval
  console.log(cmd+" "+id);
  
  // device accepting "toggleDevice" command

  var customID = id.includes("button");
  if(customID)
  {
    //console.log("customID detected for object #"+id);
    id = id.replace("button", ""); // restore the id if it's a modified one (due to level/button combination)
    //console.log("now id restored to its original value: "+id);
  }
  var url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"/"+cmd+"?"+access_token;    
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
    };
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();

  if(feedBackLoop != true)
  {
    setTimeout(function(){getData(id, customID)}, 1000);
  }
  else
  {
    //console.log("preventing feedBackLoop")
  }
  setTimeout(function(){updateButtonColor(id, "startup", "startup", "startup", "startup")}, 800);
};

function toggleLock(cmd, id)
{
  var value = lockState // get the last state
  //console.log("lock id:"+id+" is "+value)
  if(value == null || value == undefined) 
    {
      console.log("REQUEST STOPPED")
      return 
    }
  var lockCMD = value == "locked" ? "unlock" : "lock"
  console.log("sending lock cmd: "+lockCMD)
  var url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"/"+lockCMD+"?"+access_token;    
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
    };
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();

  setTimeout(function(){getLockState(id)}, 4000); // refresh the value in N seconds
}

function PrepToggleDevice(id){
  clearTimeout(PrepToggleDeviceTimeout);
  PrepToggleDeviceTimeout = setTimeout(function(){toggleDevice(cmdSwitch, id)}, 1000); 
}
/*******************************END OF DEVICE COMMANDS**************************************/

function refreshLocks()
{
  var s = lockList.length
  for(var i = 0; i<s; i++)
  {
    //console.log("refreshing lock:"+lockList[i][0])
    getLockState(lockList[i][0])
  }
};

function getLockState(id)
{
  
  url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+id+"?"+access_token; 
  //   http://"+ip+"/apps/api/1348/devices/2519?access_token=8b5615ed-43a6-4318-bd88-af5f1e2c30bd; 
  var xmlhttp = new XMLHttpRequest();
  
  var value = null

  xmlhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var myObj = JSON.parse(this.responseText);
      var i = 0
      var s = myObj.attributes.length
      for(i=0;i<s;i++) // search for the "lock" attribute name
      {
        //console.log("myObj.attributes[i].name = "+myObj.attributes[i].name)
        if(myObj.attributes[i].name == "lock")
        {
          value = myObj.attributes[i].currentValue 
          //console.log("myObj.attributes[i].currentValue = "+myObj.attributes[i].currentValue)  
          //console.log("returning:"+value)
          lockState = value 
          document.getElementById(id).innerHTML = myObj.label+" is "+lockState; //needs to be updated here due to shit variable not being retained...
          //console.log(myObj.id+" "+value +" getLockState() "+ myObj.label+" "+myObj.type+" "+myObj.type)
          updateButtonColor(myObj.id, value, "getLockState()", myObj.label, myObj.type, myObj.type);
        }
      }
    };
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();
}

function updatePowerMeters()
{
  mainPower = 0
  acPower = 0
  otherPowerSwitches = 0
  //console.log("updatePowerMeters()")  
  if(powerMeters.length == 0)
  {
    //console.log("No power meters to check")
    return 
  } 
  var s = powerMeters.length 
  
  //console.log("powerMeters size ="+s)
  for(var i=0;i<s;i++)
  {
     (function(i){
        var thisId = powerMeters[i][0] // power meter device's ID
        var thisLabel = powerMeters[i][1]
        var labelLowerCase = thisLabel.toLowerCase()
        thereIsAMainMeter = labelLowerCase.includes("main meter") || labelLowerCase.includes("main power meter")
        
        // Retain `i` in this scope, for use later (after timeout)
        setTimeout(function(){getPowerVal(thisId, thisLabel);}, 100 * i);
    })(i);
    setTimeout(function(){getPower()}, 2000); // prevent data overflow
  }}

function getPowerVal(thisId, thisLabel)
{
  //console.log("power meter id = "+thisId)
  var capUrl = url = "http://"+ip+"/apps/api/"+appNumber+"/devices/"+thisId+"?"+access_token;
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() 
  {
    if (this.readyState == 4 && this.status == 200) 
    {
      //console.log("qualifying content");
      var data = JSON.parse(this.responseText);
      //console.log("attributes = "+JSON.stringify(data.attributes[0].name))
      var size = data.attributes.length // attributes for thisId
      var labelLowerCase = thisLabel.toLowerCase()
      var isMainMeter = labelLowerCase.includes("main meter") || labelLowerCase.includes("main power meter") // needed with thereIsMainMeter to id the individual related object
      var isACpower = thisLabel.includes("AC POWER")
      
      for(var a=0;a<size;a++)
      {
        //console.log(thisLabel+" a="+a)
        var attributeName = data.attributes[a].name
        //console.log("attribute name for "+thisId+" = "+JSON.stringify(attributeName))
        if(attributeName == "power")
        {
          var currentValue = data.attributes[a].currentValue
          //console.log("currentValue = "+currentValue)          
          //console.log("power value for "+thisId+" = "+JSON.stringify(currentValue))
          var buttonToChange = document.getElementById(thisId)
          var valueToShow = thisLabel+" "+currentValue+"W"
          //console.log("valueToShow = "+valueToShow)
          var label = trimLabel(thisLabel, 18)
          //buttonToChange.style.content=valueToShow
          
          if(isACpower) // if it's an AC
          {
            acPower += currentValue
          }
          else if(isMainMeter == true)
          {
            //console.log("MAIN METER VALUE = "+currentValue)
            mainPower = currentValue 
          }
          else // if nor an AC nor a main meter
          {
            //console.log("not additioning because there's a home energy meter")
            otherPowerSwitches += currentValue // for all other devices that are not main meter (AC power meters are NOT included in this sum)
          }
          if(!isMainMeter) // beside for the main meter, update the tile for all other devices
          {
            // value to show is only for regular energy power switches, not a simple meter, which has not corresponding object as such on the 
            // page for now. 
            document.getElementById(thisId).innerHTML = valueToShow // update the individual device displayed power value
          }
        }
      }
    };
  };
  xmlhttp.open("GET", capUrl, true);
  xmlhttp.send();
}

function getPower()
{
  document.getElementById("homepower").innerHTML = parseInt(mainPower)+"W"
  document.getElementById("acpower").innerHTML = "AC:"+parseInt(acPower)+"W"
  document.getElementById("otherpowerswitches").innerHTML = "OTHER:"+parseInt(otherPowerSwitches)+"W"
}

function refreshSlider(deviceId, value, label)
{
  var s = spanIdList.length;
  var spanId = ""; // deprecated, now value is shown on the button directly
  var buttonId = "" // object id of the button onto wich we want to display the device name + its value in %
  var buttonName = "" // just for display purpose, not an object id... 
  for(var i = 0;i<s;i++)
  {
    ////console.log("panIdList @ index ["+i+"][0] = "+spanIdList[i][0]);
    ////console.log("Checking list @ index ["+i+"][1] = "+spanIdList[i][1]);
    if(spanIdList[i][0] == deviceId){

      spanId = spanIdList[i][1];
      buttonName = spanIdList[i][2];
      //console.log("FOUND spanId "+spanId+" for : "+label);
    }
  }
  buttonId = deviceId+"button"
  document.getElementById(spanId).innerHTML = value; // update span number value
  document.getElementById(deviceId).value = value;// update the value displayed on the slider}
}

function sliderEventListener()
{
  // create an event listener for all sliders inputs, if any
  var b = spanIdList.length;
  var n = 0;
  //console.log("b = "+b+" n = "+n);
  for (b != 0; n < b; n++ ) { 
    //[deviceId, spanSliderId]  
    var slider = spanIdList[n][0]; // slider object id
    var output = spanIdList[n][1]; // span object that shows the value number
    //console.log("creating listener for "+slider+" && "+output);
    var rangeInput = document.getElementById(spanIdList[n][0]);    
    rangeInput.addEventListener("input", sliderOutput(slider, output, n), false);
  };
}

function sliderOutput(sliderObj, spanObj, n)
{
  var buttonId = sliderObj+"button" // the id of the corresponding on/off button
  var buttonName = spanIdList[n][2];
  var deviceLabel = spanObj;
  //console.log(buttonName+" "+deviceLabel+" spanObj is:"+spanIdList[n][1])
  var slider = document.getElementById(sliderObj);
  var output = document.getElementById(spanObj);
  //var output2 = document.getElementById(buttonId);

  //console.log(buttonName+"slider value: "+slider.value+"%")
  
  output.value = slider.value; // update the slider position
  output.innerHTML = slider.value;// update span number dispayed value // we actually prefer to keep the value as modified with cursor otherwise we get the last value and the new value will appear only after next refresh cycle. 
  
  slider.oninput = function() //allows to see changes as the cursor is being moved
  {
    //updates cursor and number value once input done
    output.value = slider.value; // update the slider position
    output.innerHTML = this.value;// update span number dispayed value     
    // console.log("slider.value is:"+slider.value);
    // console.log("deviceId:"+sliderObj+"button");
    if(slider.value == 0 || slider.value == 1)
    {
      //document.getElementById(sliderObj+"button").innerHTML = "off"; // we do this with colors so as to keep the device name on the button
      var calledBy = "sliderOutput 524"
      updateButtonColor(sliderObj, "off", calledBy, deviceLabel, "dimmer", "dimmer");
    }
    else
    {
      //document.getElementById(sliderObj+"button").innerHTML = "on"; // we do this with colors so as to keep the device name on the button
      var calledBy = "sliderOutput 895"
      updateButtonColor(sliderObj, "on", calledBy, deviceLabel, "dimmer", "dimmer");
    }
  }
};  

/******************************* INTERVALS AND TIMEOUTS MANAGEMENT*************************/
function setRefreshInterval(clear)
{
  isRefreshing = clear; // update global if this was a button hit (button setRefreshInterval(!isRefreshing))
  var refreshState = "NA";
  var refInterval = 0;
  if(clear == true) //powersaving mode
  {
    refInterval = powerSavingRefreshInterval;
    clearInterval(interval1); // clear the short interval  
    interval2 = setInterval(function(){refreshAll();}, powerSavingRefreshInterval); // set interval refresh of n minutes
  }
  else { 
    refInterval = refreshInterval;
    clearInterval(interval1); // clear the long interval       
    interval1 = setInterval(function(){refreshAll();}, refreshInterval);
    clearTimeout(timeoutPowerSaving);// clear any previously scheduled powerSavingTimeout
    timeoutPowerSaving = setTimeout(function(){ setRefreshInterval(true); }, powerSavingTimeout * 1000 * 60); // reset timeout
  }
  refreshState = " --- refresh rate is "+refInterval/1000+" seconds"; // value to display on top of the page
  //console.log("REFRESH STATUS IS NOW: '"+refreshState+"'")
  document.getElementById("stopscript").innerHTML = refreshState;  
  if(stopAllScripts == true && stopAllScriptsTimeout != 0)
  {
    setTimeout(function(){allScriptsOff();}, stopAllScriptsTimeout * 1000 * 60 * 60)
    console.log("All scripts will be stopped after "+stopAllScriptsTimeout+" hours");
  }
}

function allScriptsOff()
{
  powerSavingTimeout = 
  clearInterval(interval1);
  clearInterval(interval2);
  clearTimeout(timeoutPowerSaving);
}


/******************************************* CAPABILITIES BOOLEANS ***************************/
function checkDimmer(cap) 
{ // checks if device has SwitchLevel capability
  return cap == "SwitchLevel";
};

function checkSwitch(cap) 
{ // checks if device has SwitchLevel capability
  return cap == "Switch";
};

function checkLock(cap) 
{ // checks if device has lock capability
  return cap == "Lock";
};

function checkPowerMeter(cap) 
{// checks if device has powerMeter capability
 return cap == "PowerMeter";
}

function isDimmer(id)
{
  //console.log("dimmerList length="+dimmerList.length)
  for(var i = 0;i<dimmerList.length;i++)
  {
    var thisId = dimmerList[i][0]
    var matchId = thisId == id 
    //console.log("thisId = "+thisId+"(index:"+i+")")
    if(matchId)
    {
      //console.log(thisId+" device is a dimmer!")
      return true
    }
  }
  return false 
}
</script>
</html>